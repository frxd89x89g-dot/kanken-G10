<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Êº¢Ê§ú10Á¥ö„Éû„Çπ„Çø„ÉºÔºàË™≠„Åø„ÉªÊõ∏„Åç„ÉªÊõ∏„ÅçÈ†ÜÔºâ</title>
<style>
:root{--bg:#eef7ff;--card:#fff;--text:#0f172a;--muted:#64748b;--blue:#60a5fa;--yellow:#fbbf24;--good:#22c55e;--bad:#ef4444;--shadow:0 12px 30px rgba(0,0,0,.08);--r:18px}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,"Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;background:var(--bg);color:var(--text);user-select:none;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
header{position:fixed;inset:0 0 auto 0;display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;padding:12px;background:rgba(255,255,255,.86);backdrop-filter:blur(10px);border-bottom:1px solid rgba(0,0,0,.06);z-index:10}
.hud{display:flex;gap:10px;flex-wrap:wrap;align-items:center;font-weight:900}
.pill{background:#fff;border:1px solid rgba(0,0,0,.06);box-shadow:var(--shadow);padding:8px 10px;border-radius:999px;font-size:14px;white-space:nowrap}
.btnGhost{background:#fff;border:1px solid rgba(0,0,0,.08);box-shadow:var(--shadow);padding:10px 12px;border-radius:999px;font-weight:900;cursor:pointer}
.btnGhost:active{transform:translateY(1px)}
main{position:fixed;inset:74px 0 0 0;display:flex;justify-content:center;align-items:center;padding:14px}
.card{width:min(580px,94vw);background:var(--card);border:1px solid rgba(0,0,0,.06);border-radius:var(--r);box-shadow:var(--shadow);padding:18px;position:relative}
.tag{position:absolute;top:14px;left:14px;background:#e8f3ff;color:#1d4ed8;border-radius:999px;padding:6px 10px;font-weight:900;font-size:13px}
.title{margin:36px 0 8px;text-align:center;font-size:36px;font-weight:1000;color:#2563eb}
.subtitle{text-align:center;margin:0 0 14px;font-weight:900;color:#f43f5e}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px}
.btn{border:0;border-radius:14px;padding:14px 12px;font-weight:1000;cursor:pointer;background:#bfe0ff;color:#0b3b73;box-shadow:inset 0 -3px 0 rgba(0,0,0,.08);font-size:16px}
.btn:active{transform:translateY(1px);box-shadow:inset 0 -2px 0 rgba(0,0,0,.08)}
.btnAccent{background:#fde68a;color:#5b3a00}
.btnWide{width:100%}
.bigKanji{font-size:96px;text-align:center;line-height:1;margin:18px 0 6px;font-weight:1100}
.bigKana{font-size:56px;text-align:center;line-height:1.2;margin:22px 0 6px;font-weight:1100}
.prompt{text-align:center;font-weight:1000;color:#334155;margin:8px 0 10px}
.counter{text-align:center;color:var(--muted);font-weight:900;font-size:13px;margin:6px 0 0}
.choices{display:flex;flex-direction:column;gap:10px;margin-top:12px}
.choice{width:100%;background:#bfe0ff;border:1px solid rgba(0,0,0,.06);border-radius:14px;padding:14px 12px;font-weight:1100;font-size:20px;text-align:center;cursor:pointer;box-shadow:inset 0 -3px 0 rgba(0,0,0,.08)}
.choice:active{transform:translateY(1px);box-shadow:inset 0 -2px 0 rgba(0,0,0,.08)}
.explain{margin-top:10px;font-weight:900;color:var(--muted);text-align:center;font-size:13px;display:none}
.svgBox{width:240px;height:240px;margin:18px auto 8px;display:flex;justify-content:center;align-items:center;background:#fff;border-radius:16px;border:1px solid rgba(0,0,0,.06);box-shadow:inset 0 -3px 0 rgba(0,0,0,.05)}
svg{width:220px;height:220px}
.strokeBase{stroke:#111827;stroke-width:9;fill:none;stroke-linecap:round;stroke-linejoin:round;opacity:.18}
.strokeRed{stroke:#ff2d55;stroke-width:14;fill:none;stroke-linecap:round;stroke-linejoin:round;opacity:1;filter:drop-shadow(0 2px 0 rgba(0,0,0,.08))}
.loading{text-align:center;color:var(--muted);font-weight:1000;padding:40px 0 18px}
.spinner{width:34px;height:34px;border-radius:50%;border:4px solid #dbeafe;border-top-color:#2563eb;margin:0 auto 12px;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.note{margin-top:12px;font-size:12px;color:var(--muted);font-weight:800;line-height:1.4;text-align:center;white-space:pre-line}
.warn{background:#fff7ed;border:1px solid rgba(0,0,0,.06);border-radius:14px;padding:10px 12px;font-weight:900;color:#7c2d12;margin-top:12px;white-space:pre-line;line-height:1.4}
/* big feedback */
.feedback{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:999;background:rgba(255,255,255,.88)}
.feedbackBox{width:min(520px,92vw);border-radius:22px;padding:22px;box-shadow:var(--shadow);text-align:center;border:1px solid rgba(0,0,0,.06)}
.fbEmoji{font-size:64px;line-height:1;margin:2px 0 8px}
.fbText{font-size:44px;font-weight:1100;margin:0}
.fbSub{margin:10px 0 0;font-weight:950;font-size:18px}
</style>
</head>
<body>
<header>
  <div class="hud">
    <div class="pill">Lv.<span id="level">1</span></div>
    <div class="pill">ÂÆåÊàê(„É©„É≥„ÇØ3) <span id="mastered">0</span>/80</div>
    <div class="pill">„Åì„ÅÆ„Çª„ÉÉ„Éà <span id="done">0</span>/<span id="limit">20</span></div>
  </div>
  <div style="display:flex;gap:10px;align-items:center;">
    <button class="btnGhost" id="homeBtn" type="button">„Éõ„Éº„É†</button>
    <button class="btnGhost" id="resetBtn" type="button" title="Â≠¶Áøí„Éá„Éº„Çø„ÇíÂàùÊúüÂåñ„Åó„Åæ„Åô">„É™„Çª„ÉÉ„Éà</button>
  </div>
</header>
<main id="root"></main>
<div class="feedback" id="feedback">
  <div class="feedbackBox" id="feedbackBox">
    <div class="fbEmoji" id="fbEmoji">‚úÖ</div>
    <p class="fbText" id="fbText">„Åõ„ÅÑ„Åã„ÅÑÔºÅ</p>
    <div class="fbSub" id="fbSub"></div>
  </div>
</div>
<script>
/* =========================================================
   „Çº„É≠„Åã„Çâ‰Ωú„ÇäÁõ¥„ÅóÁâàÔºöÂ§ñÈÉ®ÈÄö‰ø°„Å™„ÅóÔºàÊõ∏„ÅçÈ†Ü„ÅØ strokes.json „ÇíÂêåÊ¢±Ôºâ
   - Ë™≠„Åø / ÈÅ∏Êäû„Åó„Å¶Êõ∏„Åç / Êõ∏„ÅçÈ†ÜÔºàËµ§„ÅÑÁ∑ö„Åå‰ΩïÁîªÁõÆ„ÅãÔºâ
   - iPhone„ÅßÁ¢∫ÂÆü„Å´ÂèçÂøú„Åô„ÇãÔºö„Éú„Çø„É≥„ÅØ click „ÅÆ„ÅøÔºà2ÈáçÁô∫ÁÅ´„Åï„Åõ„Å™„ÅÑÔºâ
   ========================================================= */

const root = document.getElementById('root');
const levelEl = document.getElementById('level');
const masteredEl = document.getElementById('mastered');
const doneEl = document.getElementById('done');
const limitEl = document.getElementById('limit');

const fb = document.getElementById('feedback');
const fbBox = document.getElementById('feedbackBox');
const fbEmoji = document.getElementById('fbEmoji');
const fbText = document.getElementById('fbText');
const fbSub = document.getElementById('fbSub');

document.addEventListener('touchstart', ()=>{}, {passive:true});

function el(tag, attrs={}, children=[]){
  const n = document.createElement(tag);
  for(const [k,v] of Object.entries(attrs)){
    if(k==='class') n.className = v;
    else if(k==='style') n.setAttribute('style', v);
    else if(k==='onClick') n.addEventListener('click', v);
    else n.setAttribute(k, v);
  }
  (Array.isArray(children)?children:[children]).forEach(c=>{
    if(c==null) return;
    n.appendChild(typeof c==='string' ? document.createTextNode(c) : c);
  });
  return n;
}
function screen(node){ root.innerHTML=''; root.appendChild(node); }
function shuffle(a){ const x=[...a]; for(let i=x.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[x[i],x[j]]=[x[j],x[i]];} return x; }
function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }

const KANJI = [
  "‰∏Ä","Âè≥","Èõ®","ÂÜÜ","Áéã","Èü≥","‰∏ã","ÁÅ´","Ëä±","Ë≤ù",
  "Â≠¶","Ê∞ó","‰πù","‰ºë","Áéâ","Èáë","Á©∫","Êúà","Áä¨","Ë¶ã",
  "‰∫î","Âè£","Ê†°","Â∑¶","‰∏â","Â±±","Â≠ê","Âõõ","Á≥∏","Â≠ó",
  "ËÄ≥","‰∏É","Ëªä","Êâã","ÂçÅ","Âá∫","Â•≥","Â∞è","‰∏ä","Ê£Æ",
  "‰∫∫","Ê∞¥","Ê≠£","Áîü","Èùí","Â§ï","Áü≥","Ëµ§","ÂçÉ","Â∑ù",
  "ÂÖà","Êó©","Ëçâ","Ë∂≥","Êùë","Â§ß","Áî∑","Á´π","‰∏≠","Ëô´",
  "Áî∫","Â§©","Áî∞","Âúü","‰∫å","Êó•","ÂÖ•","Âπ¥","ÁôΩ","ÂÖ´",
  "Áôæ","Êñá","Êú®","Êú¨","Âêç","ÁõÆ","Á´ã","Âäõ","Êûó","ÂÖ≠"
];

// Ë™≠„ÅøÔºöÁîüÊ¥ª„Åß‰Ωø„ÅÜÂΩ¢„Å´ÂØÑ„Åõ„Å§„Å§„ÄÅËø∑„ÅÜ„ÇÇ„ÅÆ„ÅØË®±ÂÆπ„ÇíÂÖ•„Çå„ÇãÔºà‰æãÔºö‰∏Ä=„ÅÑ„Å°/„Å≤„Å®Ôºâ
const READING = {
  "‰∏Ä":{main:"„ÅÑ„Å°", ok:["„ÅÑ„Å°","„Å≤„Å®"]},
  "Âè≥":{main:"„Åø„Åé", ok:["„Åø„Åé"]},
  "Èõ®":{main:"„ÅÇ„ÇÅ", ok:["„ÅÇ„ÇÅ"]},
  "ÂÜÜ":{main:"„Åà„Çì", ok:["„Åà„Çì"]},
  "Áéã":{main:"„Åä„ÅÜ", ok:["„Åä„ÅÜ"]},
  "Èü≥":{main:"„Åä„Å®", ok:["„Åä„Å®"]},
  "‰∏ã":{main:"„Åó„Åü", ok:["„Åó„Åü"]},
  "ÁÅ´":{main:"„Å≤", ok:["„Å≤"]},
  "Ëä±":{main:"„ÅØ„Å™", ok:["„ÅØ„Å™"]},
  "Ë≤ù":{main:"„Åã„ÅÑ", ok:["„Åã„ÅÑ"]},
  "Â≠¶":{main:"„Åå„Åè", ok:["„Åå„Åè","„Åæ„Å™„Å∂"]},
  "Ê∞ó":{main:"„Åç", ok:["„Åç"]},
  "‰πù":{main:"„Åç„ÇÖ„ÅÜ", ok:["„Åç„ÇÖ„ÅÜ"]},
  "‰ºë":{main:"„ÇÑ„Åô„ÇÄ", ok:["„ÇÑ„Åô„ÇÄ","„ÇÑ„Åô"]},
  "Áéâ":{main:"„Åü„Åæ", ok:["„Åü„Åæ"]},
  "Èáë":{main:"„Åç„Çì", ok:["„Åç„Çì","„Åã„Å≠"]},
  "Á©∫":{main:"„Åù„Çâ", ok:["„Åù„Çâ"]},
  "Êúà":{main:"„Å§„Åç", ok:["„Å§„Åç"]},
  "Áä¨":{main:"„ÅÑ„Å¨", ok:["„ÅÑ„Å¨"]},
  "Ë¶ã":{main:"„Åø„Çã", ok:["„Åø„Çã"]},
  "‰∫î":{main:"„Åî", ok:["„Åî"]},
  "Âè£":{main:"„Åè„Å°", ok:["„Åè„Å°"]},
  "Ê†°":{main:"„Åì„ÅÜ", ok:["„Åì„ÅÜ"]},
  "Â∑¶":{main:"„Å≤„Å†„Çä", ok:["„Å≤„Å†„Çä"]},
  "‰∏â":{main:"„Åï„Çì", ok:["„Åï„Çì"]},
  "Â±±":{main:"„ÇÑ„Åæ", ok:["„ÇÑ„Åæ"]},
  "Â≠ê":{main:"„Åì", ok:["„Åì"]},
  "Âõõ":{main:"„Çà„Çì", ok:["„Çà„Çì","„Åó"]},
  "Á≥∏":{main:"„ÅÑ„Å®", ok:["„ÅÑ„Å®"]},
  "Â≠ó":{main:"„Åò", ok:["„Åò"]},
  "ËÄ≥":{main:"„Åø„Åø", ok:["„Åø„Åø"]},
  "‰∏É":{main:"„Å™„Å™", ok:["„Å™„Å™","„Åó„Å°"]},
  "Ëªä":{main:"„Åè„Çã„Åæ", ok:["„Åè„Çã„Åæ"]},
  "Êâã":{main:"„Å¶", ok:["„Å¶"]},
  "ÂçÅ":{main:"„Åò„ÇÖ„ÅÜ", ok:["„Åò„ÇÖ„ÅÜ","„Å®„Åä"]},
  "Âá∫":{main:"„Åß„Çã", ok:["„Åß„Çã","„Å†„Åô"]},
  "Â•≥":{main:"„Åä„Çì„Å™", ok:["„Åä„Çì„Å™"]},
  "Â∞è":{main:"„Å°„ÅÑ„Åï„ÅÑ", ok:["„Å°„ÅÑ„Åï„ÅÑ","„Å°„ÅÑ"]},
  "‰∏ä":{main:"„ÅÜ„Åà", ok:["„ÅÜ„Åà"]},
  "Ê£Æ":{main:"„ÇÇ„Çä", ok:["„ÇÇ„Çä"]},
  "‰∫∫":{main:"„Å≤„Å®", ok:["„Å≤„Å®"]},
  "Ê∞¥":{main:"„Åø„Åö", ok:["„Åø„Åö"]},
  // Ê≠£ÔºöÂ≠ê„Å©„ÇÇÂêë„Åë„ÅØ„Äå„Åü„Å†„Åó„ÅÑ„Äç„ÅßOK„ÄÇÁü≠Á∏Æ„Äå„Åü„Å†„Äç„ÅØË™≠„Åø„Å®„Åó„Å¶„ÅØ‰∏≠ÈÄîÂçäÁ´Ø„Å™„ÅÆ„ÅßÂÖ•„Çå„Å™„ÅÑ„ÄÇ
  "Ê≠£":{main:"„Åü„Å†„Åó„ÅÑ", ok:["„Åü„Å†„Åó„ÅÑ"]},
  "Áîü":{main:"„ÅÑ„Åç„Çã", ok:["„ÅÑ„Åç„Çã","„Å™„Åæ"]},
  "Èùí":{main:"„ÅÇ„Åä", ok:["„ÅÇ„Åä"]},
  "Â§ï":{main:"„ÇÜ„ÅÜ", ok:["„ÇÜ„ÅÜ"]},
  "Áü≥":{main:"„ÅÑ„Åó", ok:["„ÅÑ„Åó"]},
  "Ëµ§":{main:"„ÅÇ„Åã", ok:["„ÅÇ„Åã"]},
  "ÂçÉ":{main:"„Åõ„Çì", ok:["„Åõ„Çì"]},
  "Â∑ù":{main:"„Åã„Çè", ok:["„Åã„Çè"]},
  "ÂÖà":{main:"„Åï„Åç", ok:["„Åï„Åç"]},
  "Êó©":{main:"„ÅØ„ÇÑ„ÅÑ", ok:["„ÅØ„ÇÑ„ÅÑ"]},
  "Ëçâ":{main:"„Åè„Åï", ok:["„Åè„Åï"]},
  "Ë∂≥":{main:"„ÅÇ„Åó", ok:["„ÅÇ„Åó"]},
  "Êùë":{main:"„ÇÄ„Çâ", ok:["„ÇÄ„Çâ"]},
  "Â§ß":{main:"„Åä„Åä„Åç„ÅÑ", ok:["„Åä„Åä„Åç„ÅÑ","„Åä„Åä"]},
  "Áî∑":{main:"„Åä„Å®„Åì", ok:["„Åä„Å®„Åì"]},
  "Á´π":{main:"„Åü„Åë", ok:["„Åü„Åë"]},
  "‰∏≠":{main:"„Å™„Åã", ok:["„Å™„Åã"]},
  "Ëô´":{main:"„ÇÄ„Åó", ok:["„ÇÄ„Åó"]},
  "Áî∫":{main:"„Åæ„Å°", ok:["„Åæ„Å°"]},
  "Â§©":{main:"„Å¶„Çì", ok:["„Å¶„Çì"]},
  "Áî∞":{main:"„Åü", ok:["„Åü"]},
  "Âúü":{main:"„Å§„Å°", ok:["„Å§„Å°"]},
  "‰∫å":{main:"„Å´", ok:["„Å´"]},
  "Êó•":{main:"„Å≤", ok:["„Å≤"]},
  // ÂÖ•ÔºöÁîüÊ¥ª„Åß„ÅØ„Äå„ÅØ„ÅÑ„Çã„Äç„Å™„ÅÆ„Åß„Åì„Çå„ÅßOK„ÄÇÂøÖË¶Å„Å™„Çâ„Äå„ÅÑ„Çã/„ÅÑ„Çå„Çã„Äç„ÇíËøΩÂä†ÂèØËÉΩ„ÄÇ
  "ÂÖ•":{main:"„ÅØ„ÅÑ„Çã", ok:["„ÅØ„ÅÑ„Çã"]},
  "Âπ¥":{main:"„Å®„Åó", ok:["„Å®„Åó","„Å≠„Çì"]},
  "ÁôΩ":{main:"„Åó„Çç", ok:["„Åó„Çç"]},
  "ÂÖ´":{main:"„ÅØ„Å°", ok:["„ÅØ„Å°"]},
  "Áôæ":{main:"„Å≤„ÇÉ„Åè", ok:["„Å≤„ÇÉ„Åè"]},
  "Êñá":{main:"„Å∂„Çì", ok:["„Å∂„Çì"]},
  "Êú®":{main:"„Åç", ok:["„Åç"]},
  "Êú¨":{main:"„Åª„Çì", ok:["„Åª„Çì"]},
  "Âêç":{main:"„Å™„Åæ„Åà", ok:["„Å™„Åæ„Åà"]},
  "ÁõÆ":{main:"„ÇÅ", ok:["„ÇÅ"]},
  "Á´ã":{main:"„Åü„Å§", ok:["„Åü„Å§"]},
  "Âäõ":{main:"„Å°„Åã„Çâ", ok:["„Å°„Åã„Çâ"]},
  "Êûó":{main:"„ÅØ„ÇÑ„Åó", ok:["„ÅØ„ÇÑ„Åó"]},
  "ÂÖ≠":{main:"„Çç„Åè", ok:["„Çç„Åè"]}
};

const STORAGE_KEY = 'kanken10_zero_v1';
const state = {
  mode: 'home',
  progress: {},
  mistakes: {},
  session: { limit:20, done:0, correct:0, total:0 },
};

function init(){
  for(const k of KANJI){ if(typeof state.progress[k] !== 'number') state.progress[k]=0; }
}
function load(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      const s = JSON.parse(raw);
      state.progress = s.progress || {};
      state.mistakes = s.mistakes || {};
    }
  }catch(e){}
  init();
}
function save(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify({progress: state.progress, mistakes: state.mistakes}));
}
function masteredCount(){ return Object.values(state.progress).filter(v=>v===3).length; }
function calcLevel(){ return Math.floor(masteredCount()/10)+1; }
function renderHud(){
  levelEl.textContent = String(calcLevel());
  masteredEl.textContent = String(masteredCount());
  doneEl.textContent = String(state.session.done||0);
  limitEl.textContent = String(state.session.limit||20);
}

function weightedPick(){
  const weights = KANJI.map(k=>{
    const rank = state.progress[k]||0;
    const base = (3-rank)+1;
    const miss = (state.mistakes[k]||0)*2;
    const damp = (rank===3)?0.4:1;
    return (base+miss)*damp;
  });
  const sum = weights.reduce((a,b)=>a+b,0);
  let r = Math.random()*sum;
  for(let i=0;i<KANJI.length;i++){ r-=weights[i]; if(r<=0) return KANJI[i]; }
  return KANJI[KANJI.length-1];
}

function makeReadingChoices(correct, count=3){
  const pool = new Set([correct]);
  while(pool.size < count){
    const k = KANJI[Math.floor(Math.random()*KANJI.length)];
    const cand = READING[k]?.main;
    if(cand && cand!==correct) pool.add(cand);
  }
  return shuffle([...pool]);
}
function makeKanjiChoices(correctKanji, count=3){
  const pool = new Set([correctKanji]);
  while(pool.size < count){
    const k = weightedPick();
    if(k!==correctKanji) pool.add(k);
  }
  return shuffle([...pool]);
}

function addMistake(k){ state.mistakes[k]=(state.mistakes[k]||0)+1; save(); }
function reduceMistake(k){ if(!state.mistakes[k]) return; state.mistakes[k]=Math.max(0,state.mistakes[k]-1); if(state.mistakes[k]===0) delete state.mistakes[k]; save(); }
function tryRankUp(kanji, targetRank){
  if(state.mode==='mock') return;
  const prev = state.progress[kanji]||0;
  const next = Math.max(prev, targetRank);
  if(next>prev){ state.progress[kanji]=next; save(); }
}

function showFeedback(ok, sub){
  fb.style.display='flex';
  fbBox.style.background = ok ? 'rgba(220,252,231,.95)' : 'rgba(254,226,226,.95)';
  fbEmoji.textContent = ok ? '‚úÖ' : '‚ùå';
  fbText.textContent = ok ? '„Åõ„ÅÑ„Åã„ÅÑÔºÅ' : '„Åñ„Çì„Å≠„Çì‚Ä¶';
  fbSub.textContent = sub || '';
  clearTimeout(showFeedback._t);
  showFeedback._t = setTimeout(()=>{ fb.style.display='none'; }, 420);
}

function viewHome(){
  state.mode='home';
  state.session = {limit:20, done:0, correct:0, total:0};
  renderHud();
  const card = el('div',{class:'card'},[
    el('div',{class:'tag'},'„É°„Éã„É•„Éº'),
    el('div',{class:'title'},'„Åã„Çì„Åë„Çì10„Åç„ÇÖ„ÅÜ'),
    el('div',{class:'subtitle'},'Ë™≠„Åø„ÉªÊõ∏„Åç„ÉªÊõ∏„ÅçÈ†Ü„Åß „ÅÇ„Åù„Å∂ÔºÅ'),
    el('div',{class:'grid'},[
      el('button',{class:'btn',type:'button',onClick:()=>startMode('yomi')},'üìñ „Çà„Åø'),
      el('button',{class:'btn',type:'button',onClick:()=>startMode('kaku')},'‚úèÔ∏è „Åã„ÅçÔºà„Åà„Çâ„Å∂Ôºâ'),
      el('button',{class:'btn',type:'button',onClick:()=>startMode('kakijun')},'1Ô∏è‚É£ „Åã„Åç„Åò„ÇÖ„Çì'),
      el('button',{class:'btn btnAccent',type:'button',onClick:()=>startMode('mock')},'‚è±Ô∏è 10„Åç„ÇÖ„ÅÜ„ÉÅ„É£„É¨„É≥„Ç∏'),
    ]),
    el('div',{class:'note'},
      'ÂêÑ„É¢„Éº„Éâ„ÅØ20ÂïèÔºà„ÉÅ„É£„É¨„É≥„Ç∏„ÅØ10ÂïèÔºâ„ÄÇ\n' +
      'Êõ∏„ÅçÈ†Ü„ÅØ strokes.json „ÇíÂêå„Åò„Éï„Ç©„É´„ÉÄ„Å´ÁΩÆ„Åë„Å∞Â§ñÈÉ®ÈÄö‰ø°„Å™„Åó„ÅßÂãï„Åç„Åæ„Åô„ÄÇ\n' +
      'Ôºàstrokes.json „ÅåÁÑ°„ÅÑ„Å®Êõ∏„ÅçÈ†Ü„Å†„ÅëËµ∑Âãï„Åß„Åç„Åæ„Åõ„ÇìÔºâ'
    )
  ]);
  screen(card);
}

function viewLoading(tag,msg){
  const card = el('div',{class:'card'},[
    el('div',{class:'tag'},tag),
    el('div',{class:'loading'},[
      el('div',{class:'spinner'}),
      el('div',{},msg||'„Çà„Åø„Åì„Åø„Å°„ÇÖ„ÅÜ‚Ä¶')
    ]),
    el('button',{class:'btn btnWide btnAccent',type:'button',onClick:viewHome},'„É°„Éã„É•„Éº„Å´„ÇÇ„Å©„Çã')
  ]);
  screen(card);
}

function viewError(tag,msg){
  const card = el('div',{class:'card'},[
    el('div',{class:'tag'},tag),
    el('div',{class:'title',style:'margin-top:18px;font-size:30px;color:#ef4444;'},'„ÅÜ„Åæ„Åè„ÅÑ„Åã„Å™„ÅÑ‚Ä¶'),
    el('div',{class:'warn'},msg),
    el('button',{class:'btn btnWide',type:'button',onClick:()=>startMode(state.mode)},'„ÇÇ„ÅÜ„ÅÑ„Å°„Å©'),
    el('button',{class:'btn btnWide btnAccent',type:'button',onClick:viewHome},'„É°„Éã„É•„Éº')
  ]);
  screen(card);
}

function viewQuestion(q){
  const explain = el('div',{class:'explain',id:'explain'}, q.explain||'');
  const choices = el('div',{class:'choices'}, q.choices.map(c=>
    el('button',{class:'choice',type:'button',onClick:()=>judge(q,c)}, c)
  ));

  const parts = [el('div',{class:'tag'}, q.tag)];
  if(q.type==='yomi'){ parts.push(el('div',{class:'bigKanji'}, q.kanji), el('div',{class:'prompt'},'„Å™„Çì„Å¶ „Çà„ÇÄ„Åã„Å™Ôºü')); }
  if(q.type==='kaku'){ parts.push(el('div',{class:'bigKana'}, q.reading), el('div',{class:'prompt'},`„Äå${q.reading}„Äç„ÅÆ „Åã„Çì„Åò„ÅØÔºü`)); }
  if(q.type==='kakijun'){
    parts.push(el('div',{class:'svgBox'}, q.svg), el('div',{class:'prompt'},'„ÅÇ„Åã„ÅÑ „Å®„Åì„Çç„ÅØ „Å™„Çì„Å∞„Çì„ÇÅÔºü'));
  }
  if(q.type==='mock'){
    parts.push(el('div',{class:'prompt'},'10„Åç„ÇÖ„ÅÜ„ÉÅ„É£„É¨„É≥„Ç∏Ôºà„É©„É≥„ÇØ„ÅØ‰∏ä„Åå„Çâ„Å™„ÅÑÔºâ'));
    if(q.inner==='yomi') parts.push(el('div',{class:'bigKanji'}, q.kanji), el('div',{class:'prompt'},'„Å™„Çì„Å¶ „Çà„ÇÄ„Åã„Å™Ôºü'));
    else parts.push(el('div',{class:'bigKana'}, q.reading), el('div',{class:'prompt'},`„Äå${q.reading}„Äç„ÅÆ „Åã„Çì„Åò„ÅØÔºü`));
  }
  parts.push(el('div',{class:'counter'}, q.counter));
  parts.push(choices);
  parts.push(explain);

  screen(el('div',{class:'card'}, parts));
}

function showExplain(){ const e=document.getElementById('explain'); if(e) e.style.display='block'; }

function startMode(mode){
  state.mode = mode;
  state.session = { limit: (mode==='mock')?10:20, done:0, correct:0, total:0 };
  renderHud();
  next();
}

// ---- strokes (local file) ----
let strokesData = null;
async function ensureStrokesLoaded(){
  if(strokesData) return strokesData;
  const controller = new AbortController();
  const t = setTimeout(()=>controller.abort(), 5000);
  try{
    const res = await fetch('./strokes.json', {cache:'no-store', signal: controller.signal});
    if(!res.ok) throw new Error('strokes.json „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„ÇìÔºàHTTP '+res.status+'Ôºâ');
    strokesData = await res.json();
    return strokesData;
  }catch(e){
    if(e && e.name==='AbortError') throw new Error('strokes.json „ÅÆË™≠„ÅøËæº„Åø„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü');
    throw e;
  }finally{ clearTimeout(t); }
}
function makeStrokeSvg(ds, redIndex){
  const svgNS = 'http://www.w3.org/2000/svg';
  const svg = document.createElementNS(svgNS,'svg');
  svg.setAttribute('viewBox','0 0 109 109');
  for(const d of ds){
    const p = document.createElementNS(svgNS,'path');
    p.setAttribute('d', d);
    p.setAttribute('class','strokeBase');
    svg.appendChild(p);
  }
  const r = ds[redIndex-1];
  if(r){
    const p = document.createElementNS(svgNS,'path');
    p.setAttribute('d', r);
    p.setAttribute('class','strokeRed');
    svg.appendChild(p);
  }
  return svg;
}

async function next(){
  if(state.session.done >= state.session.limit){
    viewHome();
    showFeedback(true, `„Åä„Çè„ÇäÔºÅ „Åõ„ÅÑ„Åã„ÅÑ ${state.session.correct}/${state.session.total}`);
    return;
  }

  try{
    if(state.mode==='yomi'){
      const kanji = weightedPick();
      const rd = READING[kanji];
      viewQuestion({
        type:'yomi', tag:'„Çà„Åø', kanji,
        choices: makeReadingChoices(rd.main,3),
        answer: rd.main,
        ok: rd.ok,
        explain: (rd.ok.length>1)?`„Åª„Åã„ÅÆ „Çà„ÅøÔºö${rd.ok.join(' / ')}`:'',
        counter: `„ÇÇ„Çì„Å†„ÅÑ ${state.session.done+1}/${state.session.limit}Ôºà„É©„É≥„ÇØÔºö${state.progress[kanji]||0}Ôºâ`
      });
      return;
    }

    if(state.mode==='kaku'){
      const kanji = weightedPick();
      const rd = READING[kanji];
      viewQuestion({
        type:'kaku', tag:'„Åã„ÅçÔºà„Åà„Çâ„Å∂Ôºâ', kanji, reading: rd.main,
        choices: makeKanjiChoices(kanji,3),
        answer: kanji,
        explain:'',
        counter: `„ÇÇ„Çì„Å†„ÅÑ ${state.session.done+1}/${state.session.limit}Ôºà„É©„É≥„ÇØÔºö${state.progress[kanji]||0}Ôºâ`
      });
      return;
    }

    if(state.mode==='kakijun'){
      const kanji = weightedPick();
      viewLoading('„Åã„Åç„Åò„ÇÖ„Çì', `„Äå${kanji}„Äç„Çí „Çà„Åø„Åì„Åø„Å°„ÇÖ„ÅÜ‚Ä¶`);

      const data = await ensureStrokesLoaded();
      const ds = data[kanji];
      if(!Array.isArray(ds) || ds.length===0) throw new Error(`strokes.json „Å´„Äå${kanji}„Äç„Åå„ÅÇ„Çä„Åæ„Åõ„Çì`);

      const total = ds.length;
      const redIndex = 1 + Math.floor(Math.random()*total);
      const choiceNums = new Set([redIndex]);
      while(choiceNums.size < 3){
        const delta = [-2,-1,1,2][Math.floor(Math.random()*4)];
        choiceNums.add(clamp(redIndex+delta,1,total));
      }
      const choices = shuffle([...choiceNums].map(n=>`${n}„Åã„Åè„ÇÅ`));

      viewQuestion({
        type:'kakijun', tag:'„Åã„Åç„Åò„ÇÖ„Çì', kanji,
        svg: makeStrokeSvg(ds, redIndex),
        choices,
        answer: `${redIndex}„Åã„Åè„ÇÅ`,
        explain: `„Äå${kanji}„Äç„ÅØ „Åú„Çì„Å∂„Åß ${total}„Åã„Åè„ÄÇ`,
        counter: `„ÇÇ„Çì„Å†„ÅÑ ${state.session.done+1}/${state.session.limit}Ôºà„É©„É≥„ÇØÔºö${state.progress[kanji]||0}Ôºâ`
      });
      return;
    }

    if(state.mode==='mock'){
      const kanji = weightedPick();
      const inner = (Math.random()<0.7)?'yomi':'kaku';
      if(inner==='yomi'){
        const rd = READING[kanji];
        viewQuestion({
          type:'mock', inner:'yomi', tag:'„ÉÅ„É£„É¨„É≥„Ç∏', kanji,
          choices: makeReadingChoices(rd.main,3),
          answer: rd.main,
          ok: rd.ok,
          explain: (rd.ok.length>1)?`„Åª„Åã„ÅÆ „Çà„ÅøÔºö${rd.ok.join(' / ')}`:'',
          counter: `„ÇÇ„Çì„Å†„ÅÑ ${state.session.done+1}/${state.session.limit}`
        });
      }else{
        const rd = READING[kanji];
        viewQuestion({
          type:'mock', inner:'kaku', tag:'„ÉÅ„É£„É¨„É≥„Ç∏', kanji, reading: rd.main,
          choices: makeKanjiChoices(kanji,3),
          answer: kanji,
          ok: null,
          explain:'',
          counter: `„ÇÇ„Çì„Å†„ÅÑ ${state.session.done+1}/${state.session.limit}`
        });
      }
      return;
    }

  }catch(err){
    viewError('„Ç®„É©„Éº',
      'Ê≠¢„Åæ„Çâ„Å™„ÅÑ„Çà„ÅÜ„Å´„ÄÅ„Åô„Åê„Å´ÂéüÂõ†„ÇíÂá∫„Åó„Åæ„Åô„ÄÇ\n\n' +
      'ÂéüÂõ†Ôºö' + (err?.message || String(err)) + '\n\n' +
      'ÂØæÁ≠ñÔºö\n' +
      '„ÉªÊõ∏„ÅçÈ†Ü„Çí‰Ωø„ÅÜ„Å™„Çâ strokes.json „Çí game.html „Å®Âêå„ÅòÂ†¥ÊâÄ„Å´ÁΩÆ„Åè\n' +
      '„ÉªGitHub Pages „Å´ÂèçÊò†Âæå„ÄÅÂº∑Âà∂Êõ¥Êñ∞ÔºàiPhone„ÅØ‰∏ã„Å´Âºï„Å£Âºµ„Å£„Å¶Êõ¥Êñ∞Ôºâ'
    );
  }
}

function judge(q, picked){
  showExplain();

  // „Åì„Åì„Åå1Âõû„Åó„ÅãÈÄ≤„Åæ„Å™„ÅÑ„Çà„ÅÜ„Å´„ÄÅÂÖà„Å´„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
  const btns = root.querySelectorAll('button.choice');
  btns.forEach(b=>b.disabled=true);

  state.session.total += 1;
  state.session.done += 1;
  renderHud();

  let ok = false;
  if(q.type==='yomi' || (q.type==='mock' && q.inner==='yomi')) ok = (q.ok||[]).includes(picked);
  else ok = (picked === q.answer);

  if(ok){
    state.session.correct += 1;
    reduceMistake(q.kanji);
    if(state.mode==='yomi') tryRankUp(q.kanji,1);
    if(state.mode==='kaku') tryRankUp(q.kanji,2);
    if(state.mode==='kakijun') tryRankUp(q.kanji,3);
    showFeedback(true);
    setTimeout(next, 260);
  }else{
    addMistake(q.kanji);
    showFeedback(false, '„Åì„Åü„ÅàÔºö' + q.answer);
    setTimeout(next, 420);
  }
}

// Buttons
document.getElementById('homeBtn').addEventListener('click', viewHome);
document.getElementById('resetBtn').addEventListener('click', ()=>{
  if(confirm('Â≠¶Áøí„Éá„Éº„Çø„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºüÔºà„É©„É≥„ÇØ„ÉªËã¶Êâã„ÅåÊ∂à„Åà„Åæ„ÅôÔºâ')){
    localStorage.removeItem(STORAGE_KEY);
    state.progress={}; state.mistakes={};
    init(); save();
    viewHome();
    showFeedback(true,'„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü');
  }
});

// Boot
load();
renderHud();
viewHome();
</script>
</body>
</html>
