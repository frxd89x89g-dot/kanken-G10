<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Êº¢Ê§ú10Á¥ö ÂãâÂº∑„Ç≤„Éº„É†</title>
<style>
  :root{
    --bg:#eef7ff; --card:#fff; --text:#0f172a; --muted:#64748b;
    --primary:#60a5fa; --accent:#fbbf24;
    --good:#22c55e; --bad:#ef4444; --shadow:0 12px 30px rgba(0,0,0,.08);
    --radius:18px;
  }
  *{box-sizing:border-box;}
  body{
    margin:0;
    font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN","Yu Gothic", sans-serif;
    background:var(--bg);
    color:var(--text);
    -webkit-tap-highlight-color: transparent;
    user-select:none;
    touch-action: manipulation;
  }
  header{
    position:fixed; inset:0 0 auto 0;
    background:rgba(255,255,255,.86);
    backdrop-filter: blur(10px);
    border-bottom:1px solid rgba(0,0,0,.06);
    padding:10px 12px;
    display:flex; justify-content:space-between; align-items:center;
    gap:10px; z-index:10;
  }
  .hud{display:flex; gap:10px; flex-wrap:wrap; align-items:center; font-weight:900;}
  .pill{
    background:#fff;
    border:1px solid rgba(0,0,0,.06);
    box-shadow: var(--shadow);
    padding:8px 10px;
    border-radius:999px;
    font-size:14px;
    white-space:nowrap;
  }
  .btnGhost{
    background:#fff;
    border:1px solid rgba(0,0,0,.08);
    color:#334155;
    box-shadow: var(--shadow);
    padding:10px 12px;
    border-radius:999px;
    font-weight:900;
  }
  .btnGhost:active{transform:translateY(1px);}
  main{
    position:fixed; inset:72px 0 0 0;
    display:flex; justify-content:center; align-items:center;
    padding:14px;
  }
  .card{
    width:min(620px, 96vw);
    background:var(--card);
    border:1px solid rgba(0,0,0,.06);
    border-radius:var(--radius);
    box-shadow: var(--shadow);
    padding:18px;
    position:relative;
  }
  .title{
    text-align:center;
    margin:8px 0 6px;
    font-size:34px;
    font-weight:1000;
    color:#2563eb;
  }
  .subtitle{ text-align:center; margin:0 0 10px; color:#f43f5e; font-weight:900;}
  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:14px;}
  .btn{
    border:0; border-radius:14px; padding:14px 12px;
    font-weight:1000; font-size:16px;
    background:#bfe0ff; color:#0b3b73;
    box-shadow: inset 0 -3px 0 rgba(0,0,0,.08);
  }
  .btn:active{ transform: translateY(1px); box-shadow: inset 0 -2px 0 rgba(0,0,0,.08); }
  .btnAccent{ background:#fde68a; color:#5b3a00; }

  .bigKanji{ font-size:96px; text-align:center; margin:14px 0 6px; line-height:1; font-weight:1000;}
  .bigKana{ font-size:54px; text-align:center; margin:18px 0 6px; line-height:1.2; font-weight:1000;}
  .prompt{ text-align:center; font-weight:1000; color:#334155; margin:8px 0 6px;}
  .counter{ text-align:center; color:var(--muted); font-weight:900; font-size:13px; margin:6px 0 0; }

  .choices{ display:flex; flex-direction:column; gap:10px; margin-top:12px;}
  .choice{
    width:100%;
    background:#bfe0ff;
    border:1px solid rgba(0,0,0,.06);
    border-radius:14px;
    padding:14px 12px;
    font-weight:1000;
    font-size:20px;
    text-align:center;
    box-shadow: inset 0 -3px 0 rgba(0,0,0,.08);
  }
  .choice:active{ transform: translateY(1px); box-shadow: inset 0 -2px 0 rgba(0,0,0,.08); }

  .svgBox{
    width:260px; height:260px; margin:16px auto 6px;
    display:flex; justify-content:center; align-items:center;
    background:#fff; border-radius:16px;
    border:1px solid rgba(0,0,0,.06);
    box-shadow: inset 0 -3px 0 rgba(0,0,0,.05);
  }
  svg{ width:240px; height:240px; }
  .strokeBase{
    stroke:#111827; stroke-width:9; fill:none;
    stroke-linecap:round; stroke-linejoin:round; opacity:.22;
  }
  .strokeRed{
    stroke:#ff3b30; stroke-width:12; fill:none;
    stroke-linecap:round; stroke-linejoin:round; opacity:1;
    filter: drop-shadow(0 2px 0 rgba(0,0,0,.08));
  }

  .loading{
    padding:22px 0 8px;
    text-align:center;
    color:var(--muted);
    font-weight:1000;
  }
  .spinner{
    width:34px; height:34px; border-radius:50%;
    border:4px solid #dbeafe; border-top-color:#2563eb;
    margin:0 auto 10px; animation: spin 1s linear infinite;
  }
  @keyframes spin{ to{ transform: rotate(360deg);} }

  /* Ê≠£Ëß£/‰∏çÊ≠£Ëß£ÔºöÂ§ß„Åç„Åè‰∏≠Â§Æ„Å´ */
  .resultOverlay{
    position:fixed; inset:0;
    display:none;
    align-items:center; justify-content:center;
    background:rgba(15,23,42,.20);
    z-index:999;
    padding:20px;
  }
  .resultCard{
    width:min(520px, 92vw);
    background:#fff;
    border-radius:22px;
    box-shadow: var(--shadow);
    border:1px solid rgba(0,0,0,.06);
    padding:18px 16px;
    text-align:center;
  }
  .resultBig{
    font-size:56px;
    font-weight:1100;
    margin:6px 0 2px;
  }
  .resultSmall{
    font-size:20px;
    font-weight:1000;
    color:#334155;
    margin:0;
  }
  .resultAns{
    margin-top:10px;
    font-size:18px;
    font-weight:900;
    color:#0f172a;
  }
  .foot{
    margin-top:12px;
    font-size:12px;
    color:var(--muted);
    font-weight:800;
    text-align:center;
    white-space:pre-line;
  }
</style>
</head>
<body>
<header>
  <div class="hud">
    <div class="pill">„É¢„Éº„ÉâÔºö<span id="hudMode">-</span></div>
    <div class="pill">„ÇÇ„Çì„Å†„ÅÑÔºö<span id="hudQ">0</span>/<span id="hudLimit">0</span></div>
    <div class="pill">„Åõ„ÅÑ„Åã„ÅÑÔºö<span id="hudOk">0</span></div>
  </div>
  <div style="display:flex; gap:10px; align-items:center;">
    <button class="btnGhost" id="homeBtn" type="button">„Éõ„Éº„É†</button>
    <button class="btnGhost" id="resetBtn" type="button">„É™„Çª„ÉÉ„Éà</button>
  </div>
</header>

<main id="root"></main>

<!-- ‚úÖ Â§ß„Åç„ÅÑÊ≠£Ë™§Ë°®Á§∫ -->
<div class="resultOverlay" id="resultOverlay">
  <div class="resultCard">
    <div class="resultBig" id="resultBig">OK</div>
    <p class="resultSmall" id="resultSmall">„Åõ„ÅÑ„Åã„ÅÑÔºÅ</p>
    <div class="resultAns" id="resultAns"></div>
    <div class="foot">„Å§„Åé„Å∏ „Åô„Åô„ÇÄ„Çà</div>
  </div>
</div>

<script>
(() => {
  const root = document.getElementById("root");
  const hudMode = document.getElementById("hudMode");
  const hudQ = document.getElementById("hudQ");
  const hudLimit = document.getElementById("hudLimit");
  const hudOk = document.getElementById("hudOk");

  const overlay = document.getElementById("resultOverlay");
  const resultBig = document.getElementById("resultBig");
  const resultSmall = document.getElementById("resultSmall");
  const resultAns = document.getElementById("resultAns");

  const STORAGE_KEY = "kanken10_simple_v1";

  const KANJI_10 = [
    "‰∏Ä","Âè≥","Èõ®","ÂÜÜ","Áéã","Èü≥","‰∏ã","ÁÅ´","Ëä±","Ë≤ù",
    "Â≠¶","Ê∞ó","‰πù","‰ºë","Áéâ","Èáë","Á©∫","Êúà","Áä¨","Ë¶ã",
    "‰∫î","Âè£","Ê†°","Â∑¶","‰∏â","Â±±","Â≠ê","Âõõ","Á≥∏","Â≠ó",
    "ËÄ≥","‰∏É","Ëªä","Êâã","ÂçÅ","Âá∫","Â•≥","Â∞è","‰∏ä","Ê£Æ",
    "‰∫∫","Ê∞¥","Ê≠£","Áîü","Èùí","Â§ï","Áü≥","Ëµ§","ÂçÉ","Â∑ù",
    "ÂÖà","Êó©","Ëçâ","Ë∂≥","Êùë","Â§ß","Áî∑","Á´π","‰∏≠","Ëô´",
    "Áî∫","Â§©","Áî∞","Âúü","‰∫å","Êó•","ÂÖ•","Âπ¥","ÁôΩ","ÂÖ´",
    "Áôæ","Êñá","Êú®","Êú¨","Âêç","ÁõÆ","Á´ã","Âäõ","Êûó","ÂÖ≠"
  ];

  // ‚úÖ Ë™≠„ÅøÔºöÂ∞èÂ≠¶Áîü„ÅåÁ≠î„Åà„ÇÑ„Åô„ÅÑ„Äå‰ª£Ë°®„Äç„Çí main „Å´„ÄÇÁîüÊ¥ª„Åß„Çà„ÅèÁúÅÁï•„Åï„Çå„ÇãÂΩ¢„ÇÇ ok „Å´ÂÖ•„Çå„Çã
  const READING = {
    "‰∏Ä": { main:"„ÅÑ„Å°", ok:["„ÅÑ„Å°","„Å≤„Å®"] },
    "Âè≥": { main:"„Åø„Åé", ok:["„Åø„Åé"] },
    "Èõ®": { main:"„ÅÇ„ÇÅ", ok:["„ÅÇ„ÇÅ"] },
    "ÂÜÜ": { main:"„Åà„Çì", ok:["„Åà„Çì"] },
    "Áéã": { main:"„Åä„ÅÜ", ok:["„Åä„ÅÜ"] },
    "Èü≥": { main:"„Åä„Å®", ok:["„Åä„Å®"] },
    "‰∏ã": { main:"„Åó„Åü", ok:["„Åó„Åü"] },
    "ÁÅ´": { main:"„Å≤", ok:["„Å≤"] },
    "Ëä±": { main:"„ÅØ„Å™", ok:["„ÅØ„Å™"] },
    "Ë≤ù": { main:"„Åã„ÅÑ", ok:["„Åã„ÅÑ"] },

    "Â≠¶": { main:"„Åæ„Å™„Å∂", ok:["„Åæ„Å™„Å∂","„Åå„Åè"] },
    "Ê∞ó": { main:"„Åç", ok:["„Åç"] },
    "‰πù": { main:"„Åç„ÇÖ„ÅÜ", ok:["„Åç„ÇÖ„ÅÜ"] },
    "‰ºë": { main:"„ÇÑ„Åô„ÇÄ", ok:["„ÇÑ„Åô„ÇÄ","„ÇÑ„Åô"] },
    "Áéâ": { main:"„Åü„Åæ", ok:["„Åü„Åæ"] },
    "Èáë": { main:"„Åç„Çì", ok:["„Åç„Çì","„Åã„Å≠"] },
    "Á©∫": { main:"„Åù„Çâ", ok:["„Åù„Çâ"] },
    "Êúà": { main:"„Å§„Åç", ok:["„Å§„Åç"] },
    "Áä¨": { main:"„ÅÑ„Å¨", ok:["„ÅÑ„Å¨"] },
    "Ë¶ã": { main:"„Åø„Çã", ok:["„Åø„Çã"] },

    "‰∫î": { main:"„Åî", ok:["„Åî"] },
    "Âè£": { main:"„Åè„Å°", ok:["„Åè„Å°"] },
    "Ê†°": { main:"„Åì„ÅÜ", ok:["„Åì„ÅÜ"] },
    "Â∑¶": { main:"„Å≤„Å†„Çä", ok:["„Å≤„Å†„Çä"] },
    "‰∏â": { main:"„Åï„Çì", ok:["„Åï„Çì"] },
    "Â±±": { main:"„ÇÑ„Åæ", ok:["„ÇÑ„Åæ"] },
    "Â≠ê": { main:"„Åì", ok:["„Åì"] },
    "Âõõ": { main:"„Çà„Çì", ok:["„Çà„Çì","„Åó"] },
    "Á≥∏": { main:"„ÅÑ„Å®", ok:["„ÅÑ„Å®"] },
    "Â≠ó": { main:"„Åò", ok:["„Åò"] },

    "ËÄ≥": { main:"„Åø„Åø", ok:["„Åø„Åø"] },
    "‰∏É": { main:"„Å™„Å™", ok:["„Å™„Å™","„Åó„Å°"] },
    "Ëªä": { main:"„Åè„Çã„Åæ", ok:["„Åè„Çã„Åæ"] },
    "Êâã": { main:"„Å¶", ok:["„Å¶"] },
    "ÂçÅ": { main:"„Åò„ÇÖ„ÅÜ", ok:["„Åò„ÇÖ„ÅÜ","„Å®„Åä"] },
    "Âá∫": { main:"„Åß„Çã", ok:["„Åß„Çã","„Å†„Åô"] },
    "Â•≥": { main:"„Åä„Çì„Å™", ok:["„Åä„Çì„Å™"] },
    "Â∞è": { main:"„Å°„ÅÑ„Åï„ÅÑ", ok:["„Å°„ÅÑ„Åï„ÅÑ","„Å°„ÅÑ"] },
    "‰∏ä": { main:"„ÅÜ„Åà", ok:["„ÅÜ„Åà"] },
    "Ê£Æ": { main:"„ÇÇ„Çä", ok:["„ÇÇ„Çä"] },

    "‰∫∫": { main:"„Å≤„Å®", ok:["„Å≤„Å®"] },
    "Ê∞¥": { main:"„Åø„Åö", ok:["„Åø„Åö"] },
    // ‚úÖ „Åì„Åì„ÅåË≥™Âïè„ÅÆ„Éù„Ç§„É≥„ÉàÔºöÁîüÊ¥ª„Åß„ÅØ„Äå„Åü„Å†„Äç„ÇÇË®Ä„ÅÜ„ÅÆ„Åß‰∏°ÊñπOK„Å´
    "Ê≠£": { main:"„Åü„Å†„Åó„ÅÑ", ok:["„Åü„Å†„Åó„ÅÑ","„Åü„Å†"] },
    "Áîü": { main:"„ÅÑ„Åç„Çã", ok:["„ÅÑ„Åç„Çã","„Å™„Åæ"] },
    "Èùí": { main:"„ÅÇ„Åä", ok:["„ÅÇ„Åä"] },
    "Â§ï": { main:"„ÇÜ„ÅÜ", ok:["„ÇÜ„ÅÜ"] },
    "Áü≥": { main:"„ÅÑ„Åó", ok:["„ÅÑ„Åó"] },
    "Ëµ§": { main:"„ÅÇ„Åã", ok:["„ÅÇ„Åã"] },
    "ÂçÉ": { main:"„Åõ„Çì", ok:["„Åõ„Çì"] },
    "Â∑ù": { main:"„Åã„Çè", ok:["„Åã„Çè"] },

    "ÂÖà": { main:"„Åï„Åç", ok:["„Åï„Åç"] },
    "Êó©": { main:"„ÅØ„ÇÑ„ÅÑ", ok:["„ÅØ„ÇÑ„ÅÑ","„ÅØ„ÇÑ"] },
    "Ëçâ": { main:"„Åè„Åï", ok:["„Åè„Åï"] },
    "Ë∂≥": { main:"„ÅÇ„Åó", ok:["„ÅÇ„Åó"] },
    "Êùë": { main:"„ÇÄ„Çâ", ok:["„ÇÄ„Çâ"] },
    "Â§ß": { main:"„Åä„Åä„Åç„ÅÑ", ok:["„Åä„Åä„Åç„ÅÑ","„Åä„Åä"] },
    "Áî∑": { main:"„Åä„Å®„Åì", ok:["„Åä„Å®„Åì"] },
    "Á´π": { main:"„Åü„Åë", ok:["„Åü„Åë"] },
    "‰∏≠": { main:"„Å™„Åã", ok:["„Å™„Åã"] },
    "Ëô´": { main:"„ÇÄ„Åó", ok:["„ÇÄ„Åó"] },

    "Áî∫": { main:"„Åæ„Å°", ok:["„Åæ„Å°"] },
    "Â§©": { main:"„Å¶„Çì", ok:["„Å¶„Çì"] },
    "Áî∞": { main:"„Åü", ok:["„Åü"] },
    "Âúü": { main:"„Å§„Å°", ok:["„Å§„Å°"] },
    "‰∫å": { main:"„Å´", ok:["„Å´"] },
    "Êó•": { main:"„Å≤", ok:["„Å≤"] },
    // ‚úÖ ÂÖ•ÔºöÂçòÁã¨„Å™„Çâ„Äå„ÅØ„ÅÑ„Çã„Äç„Åå‰ª£Ë°®„ÄÇÂè£Ë™û„ÅÆ„Äå„ÅØ„ÅÑ„Äç„ÇÇOK„Å´„Åô„Çã„Å®Áîò„Åè„Å™„Çã„ÅÆ„ÅßÂÖ•„Çå„Å™„ÅÑ„ÄÇ
    "ÂÖ•": { main:"„ÅØ„ÅÑ„Çã", ok:["„ÅØ„ÅÑ„Çã","„ÅÑ„Çå„Çã"] },
    "Âπ¥": { main:"„Å®„Åó", ok:["„Å®„Åó","„Å≠„Çì"] },
    "ÁôΩ": { main:"„Åó„Çç", ok:["„Åó„Çç"] },
    "ÂÖ´": { main:"„ÅØ„Å°", ok:["„ÅØ„Å°"] },

    "Áôæ": { main:"„Å≤„ÇÉ„Åè", ok:["„Å≤„ÇÉ„Åè"] },
    "Êñá": { main:"„Å∂„Çì", ok:["„Å∂„Çì"] },
    "Êú®": { main:"„Åç", ok:["„Åç"] },
    "Êú¨": { main:"„Åª„Çì", ok:["„Åª„Çì"] },
    "Âêç": { main:"„Å™„Åæ„Åà", ok:["„Å™„Åæ„Åà"] },
    "ÁõÆ": { main:"„ÇÅ", ok:["„ÇÅ"] },
    "Á´ã": { main:"„Åü„Å§", ok:["„Åü„Å§"] },
    "Âäõ": { main:"„Å°„Åã„Çâ", ok:["„Å°„Åã„Çâ"] },
    "Êûó": { main:"„ÅØ„ÇÑ„Åó", ok:["„ÅØ„ÇÑ„Åó"] },
    "ÂÖ≠": { main:"„Çç„Åè", ok:["„Çç„Åè"] }
  };

  function $(id){ return document.getElementById(id); }
  function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
  function shuffle(a){
    const x=[...a];
    for(let i=x.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [x[i],x[j]]=[x[j],x[i]];
    }
    return x;
  }
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  function el(tag, attrs={}, children=[]){
    const n=document.createElement(tag);
    for(const [k,v] of Object.entries(attrs)){
      if(k==="class") n.className=v;
      else if(k==="style") n.setAttribute("style", v);
      else if(k.startsWith("on") && typeof v==="function"){
        n.addEventListener(k.slice(2).toLowerCase(), v);
      }else n.setAttribute(k,v);
    }
    (Array.isArray(children)?children:[children]).forEach(c=>{
      if(c==null) return;
      n.appendChild(typeof c==="string" ? document.createTextNode(c) : c);
    });
    return n;
  }
  function screen(node){ root.innerHTML=""; root.appendChild(node); }

  // ===== strokes.json „ÇíË™≠„ÇÄÔºà„É≠„Éº„Ç´„É´„ÉªGitHub Pages„ÅßÂãï„ÅèÔºâ =====
  let strokesMap = null;  // { "ÂÖ´": ["M..", ...], ... }
  async function loadStrokesOnce(){
    if(strokesMap) return strokesMap;
    const controller = new AbortController();
    const t = setTimeout(()=>controller.abort(), 6000);
    try{
      const res = await fetch("strokes.json", { cache:"no-store", signal: controller.signal });
      if(!res.ok) throw new Error("strokes.json „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì (" + res.status + ")");
      const j = await res.json();
      if(!j || !j.strokes) throw new Error("strokes.json „ÅÆÂΩ¢Âºè„ÅåÈÅï„ÅÑ„Åæ„Åô");
      strokesMap = j.strokes;
      return strokesMap;
    }catch(e){
      throw new Error((e && e.name==="AbortError") ? "strokes.json Ë™≠„ÅøËæº„Åø„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà" : (e?.message || String(e)));
    }finally{
      clearTimeout(t);
    }
  }

  function makeStrokeSvg(ds, redIndex){
    const svgNS = "http://www.w3.org/2000/svg";
    const svg = document.createElementNS(svgNS, "svg");
    svg.setAttribute("viewBox", "0 0 109 109");
    ds.forEach(d=>{
      const p = document.createElementNS(svgNS, "path");
      p.setAttribute("d", d);
      p.setAttribute("class", "strokeBase");
      svg.appendChild(p);
    });
    const r = ds[redIndex-1];
    if(r){
      const p = document.createElementNS(svgNS, "path");
      p.setAttribute("d", r);
      p.setAttribute("class", "strokeRed");
      svg.appendChild(p);
    }
    return svg;
  }

  // ===== Áä∂ÊÖã =====
  let state = {
    mode:"home", // yomi / kaku / kakijun
    limit: 20,
    q: 0,
    ok: 0,
    lock: false, // ÈÄ£Êâì„Éª‰∫åÈáçÁô∫ÁÅ´ÂØæÁ≠ñ
  };

  function saveLocal(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify({}));
  }
  function resetLocal(){
    localStorage.removeItem(STORAGE_KEY);
  }

  function renderHud(){
    const modeName = (state.mode==="yomi") ? "„Çà„Åø" :
                     (state.mode==="kaku") ? "„Åã„Åç" :
                     (state.mode==="kakijun") ? "„Åã„Åç„Åò„ÇÖ„Çì" : "-";
    hudMode.textContent = modeName;
    hudQ.textContent = String(state.q);
    hudLimit.textContent = String(state.limit);
    hudOk.textContent = String(state.ok);
  }

  function home(){
    state = { mode:"home", limit:20, q:0, ok:0, lock:false };
    renderHud();
    screen(el("div",{class:"card"},[
      el("div",{class:"title"},"Êº¢Ê§ú10Á¥ö ÂãâÂº∑„Ç≤„Éº„É†"),
      el("div",{class:"subtitle"},"„Çà„Åø / „Åã„Åç / „Åã„Åç„Åò„ÇÖ„Çì"),
      el("div",{class:"grid"},[
        el("button",{class:"btn", type:"button", onClick:()=>start("yomi")},"üìñ „Çà„ÅøÔºà20„ÇÇ„ÇìÔºâ"),
        el("button",{class:"btn", type:"button", onClick:()=>start("kaku")},"‚úèÔ∏è „Åã„ÅçÔºà20„ÇÇ„ÇìÔºâ"),
        el("button",{class:"btn btnAccent", type:"button", onClick:()=>start("kakijun")},"1Ô∏è‚É£ „Åã„Åç„Åò„ÇÖ„ÇìÔºà20„ÇÇ„ÇìÔºâ"),
        el("button",{class:"btn btnAccent", type:"button", onClick:()=>demo()},"üéÆ „Å§„Å•„Åë„Å¶„ÅÇ„Åù„Å∂Ôºà„Åä„Åô„Åô„ÇÅÔºâ"),
      ]),
      el("div",{class:"foot"},
        "iPhone„ÅßÈÅä„Åπ„Çã„Ç∑„É≥„Éó„É´Áâà\n" +
        "„Åã„Åç„Åò„ÇÖ„Çì „ÅØ strokes.json „Çí‰Ωø„ÅÑ„Åæ„ÅôÔºàÂêå„Åò„Éï„Ç©„É´„ÉÄ„Å´ÁΩÆ„ÅèÔºâ"
      )
    ]));
  }

  function demo(){
    // „Åä„Åô„Åô„ÇÅÔºö„Çà„Åø‚Üí„Åã„Åç‚Üí„Åã„Åç„Åò„ÇÖ„Çì„ÅÆÈ†Ü„Åß1„Çª„ÉÉ„Éà„Åö„Å§
    start("yomi", () => start("kaku", () => start("kakijun", () => home())));
  }

  let afterFinish = null;

  async function start(mode, onFinish=null){
    state.mode = mode;
    state.limit = 20;
    state.q = 0;
    state.ok = 0;
    state.lock = false;
    afterFinish = onFinish;
    renderHud();

    if(mode==="kakijun"){
      // ÂÖà„Å´Ë™≠„ÅøËæº„Çì„Åß„ÄåÈñãÂßã„Åß„Åç„Å™„ÅÑ„Äç„ÇíÊΩ∞„Åô
      screen(el("div",{class:"card"},[
        el("div",{class:"title"},"„Åã„Åç„Åò„ÇÖ„Çì"),
        el("div",{class:"loading"},[el("div",{class:"spinner"}),"„Éá„Éº„Çø„Çí„Çà„Åø„Åì„Åø„Å°„ÇÖ„ÅÜ‚Ä¶"])
      ]));
      try{
        await loadStrokesOnce();
      }catch(e){
        screen(el("div",{class:"card"},[
          el("div",{class:"title", style:"color:#ef4444;"},"„Ç®„É©„Éº"),
          el("div",{class:"prompt"}, "„Åã„Åç„Åò„ÇÖ„Çì „ÅÆ„Éá„Éº„Çø„ÅåË™≠„ÇÅ„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ"),
          el("div",{class:"prompt", style:"color:#ef4444;font-weight:1000;"},"ÂéüÂõ†Ôºö" + (e?.message || String(e))),
          el("button",{class:"btn btnAccent", type:"button", onClick:home},"„Éõ„Éº„É†„Å´„ÇÇ„Å©„Çã")
        ]));
        return;
      }
    }
    nextQuestion();
  }

  function finish(){
    const card = el("div",{class:"card"},[
      el("div",{class:"title"},"„Åä„Åó„Åæ„ÅÑÔºÅ"),
      el("div",{class:"subtitle"}, `${state.ok} / ${state.limit} „Åõ„ÅÑ„Åã„ÅÑ`),
      el("div",{style:"display:flex; gap:12px; margin-top:14px;"},[
        el("button",{class:"btn", type:"button", onClick:()=>start(state.mode, afterFinish)},"„ÇÇ„ÅÜ1Âõû"),
        el("button",{class:"btn btnAccent", type:"button", onClick:()=>{ if(afterFinish) afterFinish(); else home(); }},"„Å§„Åé / „Éõ„Éº„É†")
      ])
    ]);
    screen(card);
  }

  function showResult(ok, answerText){
    overlay.style.display = "flex";
    if(ok){
      resultBig.textContent = "‚≠ï";
      resultBig.style.color = "var(--good)";
      resultSmall.textContent = "„Åõ„ÅÑ„Åã„ÅÑÔºÅ";
    }else{
      resultBig.textContent = "‚ùå";
      resultBig.style.color = "var(--bad)";
      resultSmall.textContent = "„Åñ„Çì„Å≠„Çì‚Ä¶";
    }
    resultAns.textContent = answerText || "";
    // „Çø„ÉÉ„Éó„ÅßÊ¨°„Å∏
    const go = () => {
      overlay.style.display = "none";
      overlay.removeEventListener("click", go);
      state.lock = false;
      nextQuestion();
    };
    overlay.addEventListener("click", go);
  }

  function makeReadingChoices(correct, n=3){
    const set = new Set([correct]);
    while(set.size < n){
      const k = pick(KANJI_10);
      const r = READING[k]?.main;
      if(r && r !== correct) set.add(r);
    }
    return shuffle([...set]);
  }
  function makeKanjiChoices(correct, n=3){
    const set = new Set([correct]);
    while(set.size < n){
      const k = pick(KANJI_10);
      if(k !== correct) set.add(k);
    }
    return shuffle([...set]);
  }

  async function nextQuestion(){
    if(state.q >= state.limit){
      finish();
      return;
    }
    state.q += 1;
    renderHud();

    if(state.mode === "yomi"){
      const kanji = pick(KANJI_10);
      const rd = READING[kanji];
      const choices = makeReadingChoices(rd.main, 3);
      screen(el("div",{class:"card"},[
        el("div",{class:"bigKanji"}, kanji),
        el("div",{class:"prompt"},"„Å™„Çì„Å¶ „Çà„ÇÄ„Åã„Å™Ôºü"),
        el("div",{class:"choices"},
          choices.map(c => el("button",{class:"choice", type:"button", onClick:()=>judgeYomi(kanji, rd, c)}, c))
        ),
        el("div",{class:"counter"}, `„ÇÇ„Çì„Å†„ÅÑ ${state.q}/${state.limit}`)
      ]));
      return;
    }

    if(state.mode === "kaku"){
      const kanji = pick(KANJI_10);
      const rd = READING[kanji];
      const choices = makeKanjiChoices(kanji, 3);
      screen(el("div",{class:"card"},[
        el("div",{class:"bigKana"}, rd.main),
        el("div",{class:"prompt"}, `„Äå${rd.main}„Äç„ÅÆ „Åã„Çì„Åò„ÅØÔºü`),
        el("div",{class:"choices"},
          choices.map(c => el("button",{class:"choice", type:"button", onClick:()=>judgeKaku(kanji, rd, c)}, c))
        ),
        el("div",{class:"counter"}, `„ÇÇ„Çì„Å†„ÅÑ ${state.q}/${state.limit}`)
      ]));
      return;
    }

    if(state.mode === "kakijun"){
      const kanji = pick(KANJI_10);
      const map = await loadStrokesOnce();
      const ds = map[kanji];
      if(!ds || !ds.length){
        // ‰∏á„Åå‰∏Ä„Åì„Åì„Å†„ÅëÊ¨†„Åë„Å¶„Å¶„ÇÇÊ≠¢„Åæ„Çâ„Å™„ÅÑ
        screen(el("div",{class:"card"},[
          el("div",{class:"title", style:"color:#ef4444;"},"„Éá„Éº„Çø„Å™„Åó"),
          el("div",{class:"prompt"}, `„Äå${kanji}„Äç„ÅÆÊõ∏„ÅçÈ†Ü„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ`),
          el("button",{class:"btn btnAccent", type:"button", onClick:home},"„Éõ„Éº„É†„Å´„ÇÇ„Å©„Çã")
        ]));
        return;
      }

      const total = ds.length;
      const redIndex = 1 + Math.floor(Math.random()*total);

      const nums = new Set([redIndex]);
      while(nums.size < 3){
        const delta = pick([-2,-1,1,2]);
        nums.add(clamp(redIndex + delta, 1, total));
      }
      const choices = shuffle([...nums].map(n => `${n}„Åã„Åè„ÇÅ`));

      const svgNode = makeStrokeSvg(ds, redIndex);

      screen(el("div",{class:"card"},[
        el("div",{class:"svgBox"}, svgNode),
        el("div",{class:"prompt"},"„ÅÇ„Åã„ÅÑ „Å®„Åì„Çç„ÅØ „Å™„Çì„Å∞„Çì„ÇÅÔºü"),
        el("div",{class:"choices"},
          choices.map(c => el("button",{class:"choice", type:"button", onClick:()=>judgeKakijun(kanji, redIndex, total, c)}, c))
        ),
        el("div",{class:"counter"}, `„ÇÇ„Çì„Å†„ÅÑ ${state.q}/${state.limit}`)
      ]));
      return;
    }
  }

  function judgeYomi(kanji, rd, picked){
    if(state.lock) return;
    state.lock = true;

    const ok = (rd.ok || []).includes(picked);
    if(ok) state.ok += 1;

    const ans = ok ? "" : `„Åì„Åü„ÅàÔºö${rd.main}`;
    showResult(ok, ans);
    renderHud();
  }

  function judgeKaku(kanji, rd, picked){
    if(state.lock) return;
    state.lock = true;

    const ok = (picked === kanji);
    if(ok) state.ok += 1;

    const ans = ok ? "" : `„Åì„Åü„ÅàÔºö${kanji}`;
    showResult(ok, ans);
    renderHud();
  }

  function judgeKakijun(kanji, redIndex, total, picked){
    if(state.lock) return;
    state.lock = true;

    const answer = `${redIndex}„Åã„Åè„ÇÅ`;
    const ok = (picked === answer);
    if(ok) state.ok += 1;

    const ans = ok ? `(${kanji}) „Åú„Çì„Å∂„Åß ${total}„Åã„Åè` : `„Åì„Åü„ÅàÔºö${answer}  (${kanji} „ÅØ ${total}„Åã„Åè)`;
    showResult(ok, ans);
    renderHud();
  }

  document.getElementById("homeBtn").addEventListener("click", home);
  document.getElementById("resetBtn").addEventListener("click", ()=>{
    if(confirm("„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü")){
      resetLocal();
      home();
    }
  });

  // ‰∫àÊúü„Åõ„Å¨„Ç®„É©„Éº„ÇÇÁîªÈù¢„Å´Âá∫„ÅôÔºàÁÑ°ÂèçÂøúÈò≤Ê≠¢Ôºâ
  window.addEventListener("error", (e)=>{
    alert("„Ç®„É©„Éº: " + (e?.message || "unknown"));
  });
  window.addEventListener("unhandledrejection", (e)=>{
    alert("„Ç®„É©„Éº: " + (e?.reason?.message || String(e?.reason || e)));
  });

  // Ëµ∑Âãï
  saveLocal(); // ‰ªäÂõû„ÅØÂ≠¶Áøí„Éá„Éº„Çø„ÅØÊåÅ„Åü„Å™„ÅÑÔºà„Çº„É≠„Åã„Çâ„ÅÆË¶ÅÊúõÔºâ
  home();
})();
</script>
</body>
</html>
