<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>æ¼¢æ¤œ10ç´š å‹‰å¼·ã‚²ãƒ¼ãƒ </title>
<style>
  :root {
    --bg: #eef6ff;
    --card: #ffffff;
    --ink: #233;
    --muted: #667;
    --accent: #2b6cb0;
    --ok: #1f8a3b;
    --ng: #d64545;
    --btn: #e9f1ff;
    --btn2: #fff2c6;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
    background: linear-gradient(180deg, #f7fbff 0%, var(--bg) 40%, var(--bg) 100%);
    color: var(--ink);
  }
  header {
    position: sticky;
    top: 0;
    z-index: 50;
    padding: 10px 10px calc(10px + env(safe-area-inset-top));
    background: rgba(247,251,255,0.95);
    backdrop-filter: blur(6px);
    border-bottom: 1px solid rgba(0,0,0,0.04);
  }
  .toprow { display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
  .pills { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .pill {
    background:#fff;
    border:1px solid rgba(0,0,0,0.08);
    border-radius:999px;
    padding:7px 10px;
    font-size:14px;
    font-weight:800;
  }
  .actions { display:flex; gap:8px; }
  .action {
    border:0;
    border-radius:999px;
    padding:10px 14px;
    font-weight:900;
    font-size:14px;
    background:#fff;
    border:1px solid rgba(0,0,0,0.08);
  }
  main { padding:18px 14px 40px; max-width:720px; margin:0 auto; }
  .card {
    background:var(--card);
    border-radius:18px;
    padding:18px 16px;
    box-shadow:0 10px 28px rgba(14,30,37,0.10);
    border:1px solid rgba(0,0,0,0.05);
  }
  .title { font-weight:1000; font-size:18px; margin:0 0 10px; }
  .kanjiBig { font-size:112px; font-weight:900; text-align:center; margin:4px 0 6px; line-height:1.0; }
  .prompt { text-align:center; font-weight:900; font-size:18px; color:var(--muted); margin:8px 0 10px; }
  .choices { display:grid; gap:10px; margin-top:12px; }
  .btn {
    width:100%;
    border:0;
    border-radius:14px;
    padding:16px 14px;
    font-size:20px;
    font-weight:1000;
    background:var(--btn);
    color:var(--ink);
    box-shadow:0 4px 0 rgba(0,0,0,0.08);
    touch-action: manipulation;
  }
  .btn:active { transform: translateY(1px); box-shadow:0 3px 0 rgba(0,0,0,0.08); }
  .btn.secondary { background:var(--btn2); }
  .tiny { font-size:13px; color:var(--muted); text-align:center; margin-top:10px; line-height:1.4; }

  .strokeBox { display:flex; justify-content:center; align-items:center; margin:6px 0 6px; }
  svg.kanjiSvg { width:240px; height:240px; background:#fff; border-radius:16px; border:1px solid rgba(0,0,0,0.08); }
  .sGray { stroke:#c7d3df; stroke-width:6; fill:none; stroke-linecap:round; stroke-linejoin:round; }
  .sHi   { stroke:#e03a3a; stroke-width:10; fill:none; stroke-linecap:round; stroke-linejoin:round; }

  .overlay {
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    padding:18px;
    background:rgba(15,25,35,0.45);
    z-index:100;
  }
  .overlay.show { display:flex; }
  .toast {
    width:min(520px, 100%);
    background:#fff;
    border-radius:18px;
    padding:18px 16px;
    text-align:center;
    box-shadow:0 20px 50px rgba(0,0,0,0.25);
  }
  .bigMark { font-size:52px; font-weight:1100; margin:4px 0 8px; }
  .bigMark.ok { color:var(--ok); }
  .bigMark.ng { color:var(--ng); }
  .sub { font-size:16px; color:var(--muted); margin-bottom:12px; font-weight:900; }
  .row { display:flex; gap:10px; margin-top:8px; }
  .row .btn { font-size:18px; padding:14px 12px; }
</style>
</head>
<body>
<header>
  <div class="toprow">
    <div class="pills">
      <div class="pill" id="pillLevel">Lv.1</div>
      <div class="pill" id="pillRank">å®Œæˆ(ãƒ©ãƒ³ã‚¯3) 0/80</div>
      <div class="pill" id="pillSet">ã“ã®ã‚»ãƒƒãƒˆ 0/20</div>
    </div>
    <div class="actions">
      <button class="action" id="btnHome">ãƒ›ãƒ¼ãƒ </button>
      <button class="action" id="btnReset">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </div>
</header>

<main>
  <div class="card" id="card"></div>
</main>

<div class="overlay" id="overlay">
  <div class="toast">
    <div class="bigMark" id="mark">â—‹</div>
    <div class="sub" id="overlayText">ã›ã„ã‹ã„ï¼</div>
    <div class="row">
      <button class="btn secondary" id="btnNext">ã¤ãã¸</button>
      <button class="btn" id="btnToHome2">ãƒ›ãƒ¼ãƒ </button>
    </div>
  </div>
</div>

<script>
(() => {
  "use strict";

  // -----------------------
  // Data (JJ can edit here)
  // -----------------------
  const YOMI_QUESTIONS = [{"k": "ä¸€", "a": ["ã„ã¡"], "c": ["ã„ã¡", "ã²ã¨", "ã„ã£"]}, {"k": "äºŒ", "a": ["ã«"], "c": ["ã«", "ãµãŸ", "ã˜"]}, {"k": "ä¸‰", "a": ["ã•ã‚“"], "c": ["ã•ã‚“", "ã¿", "ã•"]}, {"k": "å››", "a": ["ã‚ˆã‚“", "ã—"], "c": ["ã‚ˆã‚“", "ã—", "ã‚ˆ"]}, {"k": "äº”", "a": ["ã”"], "c": ["ã”", "ã„ã¤", "ã„"]}, {"k": "å…­", "a": ["ã‚ã"], "c": ["ã‚ã", "ã‚€", "ã‚"]}, {"k": "ä¸ƒ", "a": ["ãªãª", "ã—ã¡"], "c": ["ãªãª", "ã—ã¡", "ãª"]}, {"k": "å…«", "a": ["ã¯ã¡"], "c": ["ã¯ã¡", "ã‚„", "ã¯"]}, {"k": "ä¹", "a": ["ãã‚…ã†", "ã"], "c": ["ãã‚…ã†", "ã", "ã“"]}, {"k": "å", "a": ["ã˜ã‚…ã†"], "c": ["ã˜ã‚…ã†", "ã¨ãŠ", "ã˜"]}, {"k": "å…¥", "a": ["ã„ã‚‹", "ã¯ã„ã‚‹", "ã„ã‚Œã‚‹"], "c": ["ã¯ã„ã‚‹", "ã„ã‚‹", "ã„ã‚Œã‚‹"]}, {"k": "å‡º", "a": ["ã§ã‚‹", "ã ã™"], "c": ["ã§ã‚‹", "ã ã™", "ã—ã‚…ã¤"]}, {"k": "äºº", "a": ["ã²ã¨"], "c": ["ã²ã¨", "ã«ã‚“", "ã˜ã‚“"]}, {"k": "å¤§", "a": ["ãŠãŠãã„"], "c": ["ãŠãŠãã„", "ã ã„", "ãŸã„"]}, {"k": "å°", "a": ["ã¡ã„ã•ã„"], "c": ["ã¡ã„ã•ã„", "ã—ã‚‡ã†", "ã“"]}, {"k": "ä¸Š", "a": ["ã†ãˆ", "ã‚ã’ã‚‹", "ã®ã¼ã‚‹"], "c": ["ã†ãˆ", "ã‚ã’ã‚‹", "ã˜ã‚‡ã†"]}, {"k": "ä¸‹", "a": ["ã—ãŸ", "ã•ã’ã‚‹", "ãã ã‚‹"], "c": ["ã—ãŸ", "ã•ã’ã‚‹", "ã‹"]}, {"k": "æ—¥", "a": ["ã²"], "c": ["ã²", "ã«ã¡", "ã˜ã¤"]}, {"k": "æœˆ", "a": ["ã¤ã"], "c": ["ã¤ã", "ã’ã¤", "ãŒã¤"]}, {"k": "ç«", "a": ["ã²"], "c": ["ã²", "ã‹", "ã»"]}, {"k": "æ°´", "a": ["ã¿ãš"], "c": ["ã¿ãš", "ã™ã„", "ã¿"]}, {"k": "æœ¨", "a": ["ã"], "c": ["ã", "ã‚‚ã", "ã“"]}, {"k": "é‡‘", "a": ["ã‹ã­"], "c": ["ã‹ã­", "ãã‚“", "ã“ã‚“"]}, {"k": "åœŸ", "a": ["ã¤ã¡"], "c": ["ã¤ã¡", "ã©", "ã¨"]}, {"k": "æ­£", "a": ["ãŸã ã—ã„", "ãŸã "], "c": ["ãŸã ã—ã„", "ãŸã ", "ã›ã„"]}];
  const KAKI_QUESTIONS = [{"y": "ã„ã¡", "k": "ä¸€"}, {"y": "ã«", "k": "äºŒ"}, {"y": "ã•ã‚“", "k": "ä¸‰"}, {"y": "ã‚ˆã‚“", "k": "å››"}, {"y": "ã”", "k": "äº”"}, {"y": "ã‚ã", "k": "å…­"}, {"y": "ãªãª", "k": "ä¸ƒ"}, {"y": "ã¯ã¡", "k": "å…«"}, {"y": "ãã‚…ã†", "k": "ä¹"}, {"y": "ã˜ã‚…ã†", "k": "å"}, {"y": "ã²ã¨", "k": "äºº"}, {"y": "ãŠãŠãã„", "k": "å¤§"}, {"y": "ã¡ã„ã•ã„", "k": "å°"}, {"y": "ã²", "k": "æ—¥"}, {"y": "ã¤ã", "k": "æœˆ"}, {"y": "ã¿ãš", "k": "æ°´"}, {"y": "ã", "k": "æœ¨"}, {"y": "ã‹ã­", "k": "é‡‘"}, {"y": "ã¤ã¡", "k": "åœŸ"}, {"y": "ãŸã ã—ã„", "k": "æ­£"}];

  // Stroke data is loaded from strokes.json (GitHub Pages OK).
  // â€» file:// ã§é–‹ãã¨ fetch ãŒå¤±æ•—ã—ã¾ã™ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ç¢ºèªã¯ç°¡æ˜“ã‚µãƒ¼ãƒã‹GitHub Pagesã§ï¼‰ã€‚
  const STROKES_URL = "strokes.json";

  // -----------------------
  // State
  // -----------------------
  const QS = new URLSearchParams(location.search);
  const initialMode = (QS.get("mode") || "home").toLowerCase(); // home / yomi / kaki / kakinjun

  const SET_SIZE = 20;

  const state = {
    mode: initialMode,
    setIndex: 0,
    inSetCorrect: 0,
    totalCorrect: 0,
    answered: new Set(),
    current: null,
    strokes: null,
    blocking: false,
  };

  const el = {
    card: document.getElementById("card"),
    overlay: document.getElementById("overlay"),
    mark: document.getElementById("mark"),
    overlayText: document.getElementById("overlayText"),
    btnNext: document.getElementById("btnNext"),
    btnHome: document.getElementById("btnHome"),
    btnReset: document.getElementById("btnReset"),
    btnToHome2: document.getElementById("btnToHome2"),
    pillRank: document.getElementById("pillRank"),
    pillSet: document.getElementById("pillSet"),
    pillLevel: document.getElementById("pillLevel"),
  };

  function shuffle(a) {
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function pickN(arr, n) {
    const copy = arr.slice();
    shuffle(copy);
    return copy.slice(0, n);
  }

  function setPills() {
    el.pillSet.textContent = `ã“ã®ã‚»ãƒƒãƒˆ ${state.setIndex}/${SET_SIZE}`;
    el.pillRank.textContent = `å®Œæˆ(ãƒ©ãƒ³ã‚¯3) ${state.answered.size}/80`;
    el.pillLevel.textContent = `ãƒ¢ãƒ¼ãƒ‰: ${({home:"ãƒ›ãƒ¼ãƒ ", yomi:"ã‚ˆã¿", kaki:"ã‹ã", kakinjun:"ã‹ãã˜ã‚…ã‚“"}[state.mode] || state.mode)}`;
  }

  function showOverlay(ok, text) {
    el.mark.textContent = ok ? "â—‹" : "Ã—";
    el.mark.className = "bigMark " + (ok ? "ok" : "ng");
    el.overlayText.textContent = text;
    el.overlay.classList.add("show");
  }
  function hideOverlay() {
    el.overlay.classList.remove("show");
  }

  function toHome() { location.href = "index.html"; }

  function resetAll() {
    localStorage.removeItem("k10_progress_v1");
    localStorage.removeItem("k10_strokes_cache_v1");
    location.href = "index.html";
  }

  function saveProgress() {
    const data = { answered: Array.from(state.answered), totalCorrect: state.totalCorrect };
    localStorage.setItem("k10_progress_v1", JSON.stringify(data));
  }
  function loadProgress() {
    try {
      const data = JSON.parse(localStorage.getItem("k10_progress_v1") || "null");
      if (!data) return;
      state.answered = new Set(data.answered || []);
      state.totalCorrect = data.totalCorrect || 0;
    } catch {}
  }

  // -----------------------
  // Stroke loader with cache + retry
  // -----------------------
  async function loadStrokes() {
    if (state.strokes) return state.strokes;

    try {
      const cached = localStorage.getItem("k10_strokes_cache_v1");
      if (cached) {
        const obj = JSON.parse(cached);
        if (obj && obj.strokes) {
          state.strokes = obj.strokes;
          return state.strokes;
        }
      }
    } catch {}

    const tryFetch = async () => {
      const controller = new AbortController();
      const t = setTimeout(() => controller.abort(), 12000);
      try {
        const res = await fetch(STROKES_URL, { cache: "no-store", signal: controller.signal });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const obj = await res.json();
        if (!obj || !obj.strokes) throw new Error("bad json");
        state.strokes = obj.strokes;
        try { localStorage.setItem("k10_strokes_cache_v1", JSON.stringify({strokes: state.strokes})); } catch {}
        return state.strokes;
      } finally {
        clearTimeout(t);
      }
    };

    let lastErr = null;
    for (let i=0; i<3; i++) {
      try { return await tryFetch(); }
      catch (e) { lastErr = e; await new Promise(r => setTimeout(r, 400 + i*600)); }
    }
    throw lastErr || new Error("Failed to load strokes");
  }

  // -----------------------
  // Flow
  // -----------------------
  function answerCommon(ok, detailText) {
    state.blocking = true;
    if (ok) { state.inSetCorrect += 1; state.totalCorrect += 1; }
    setPills();
    saveProgress();
    showOverlay(ok, detailText);
  }

  function renderHome() {
    state.mode = "home";
    setPills();
    el.card.innerHTML = `
      <div class="title">æ¼¢æ¤œ10ç´š å‹‰å¼·ã‚²ãƒ¼ãƒ </div>
      <div class="tiny">iPhoneã§éŠã¹ã‚‹ãƒ»ã‚µã‚¯ãƒƒã¨20å•ã€‚<br/>ã€Œã‚ˆã¿ã€ã€Œã‹ãã€ã€Œã‹ãã˜ã‚…ã‚“ã€ã®3ã¤ã§ç·´ç¿’ã—ã¾ã™ã€‚</div>
      <div class="choices" style="margin-top:14px;">
        <button class="btn" data-go="yomi">ğŸ“– ã‚ˆã¿</button>
        <button class="btn" data-go="kaki">âœï¸ ã‹ã</button>
        <button class="btn secondary" data-go="kakinjun">ğŸ§  ã‹ãã˜ã‚…ã‚“ï¼ˆè‰²ã®ã¨ã“ã‚ï¼‰</button>
      </div>
      <div class="tiny" style="margin-top:12px;">
        â€»ã€Œã‹ãã˜ã‚…ã‚“ã€ã¯ <b>strokes.json</b> ãŒåŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<br/>
        ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆfile://ï¼‰ã§é–‹ãã¨å‹•ã‹ãªã„ã®ã§ã€GitHub Pagesã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚
      </div>
    `;
    el.card.querySelectorAll("button[data-go]").forEach(b => {
      b.addEventListener("click", () => {
        const m = b.getAttribute("data-go");
        location.href = `game.html?mode=${m}`;
      });
    });
  }

  function renderSetFinished() {
    setPills();
    el.card.innerHTML = `
      <div class="title">ã“ã®ã‚»ãƒƒãƒˆãŠã‚ã‚Šï¼</div>
      <div class="prompt">ã›ã„ã‹ã„ï¼š${state.inSetCorrect} / ${SET_SIZE}</div>
      <div class="choices">
        <button class="btn secondary" id="again">ã‚‚ã†ã„ã¡ã©ï¼ˆåŒã˜ãƒ¢ãƒ¼ãƒ‰ï¼‰</button>
        <button class="btn" id="home">ãƒ›ãƒ¼ãƒ ã«ã‚‚ã©ã‚‹</button>
      </div>
      <div class="tiny">â€» 20å•ãšã¤ã€‚å°‘ã—ãšã¤ã§OKã€‚</div>
    `;
    document.getElementById("again").addEventListener("click", () => startMode(state.mode));
    document.getElementById("home").addEventListener("click", toHome);
  }

  function nextQuestion() {
    if (state.blocking) return;
    state.setIndex += 1;
    if (state.setIndex > SET_SIZE) { renderSetFinished(); return; }

    if (state.mode === "yomi") renderYomi();
    else if (state.mode === "kaki") renderKaki();
    else if (state.mode === "kakinjun") renderKakinjun();
    else renderHome();
  }

  // ---- YOMI ----
  function renderYomi() {
    const q = YOMI_QUESTIONS[Math.floor(Math.random() * YOMI_QUESTIONS.length)];
    state.current = q;
    setPills();
    const choices = shuffle(q.c.slice());
    el.card.innerHTML = `
      <div class="title">ğŸ“– ã‚ˆã¿</div>
      <div class="kanjiBig">${q.k}</div>
      <div class="prompt">ã‚ˆã¿ã¯ï¼Ÿï¼ˆã²ã‚‰ãŒãªï¼‰</div>
      <div class="choices">
        ${choices.map(c => `<button class="btn" data-ans="${c}">${c}</button>`).join("")}
      </div>
      <div class="tiny">â€»ã€Œæ­£ã€ã¯ <b>ãŸã  / ãŸã ã—ã„</b> ã©ã¡ã‚‰ã‚‚OKã«ã—ã¦ã„ã¾ã™ã€‚</div>
    `;
    el.card.querySelectorAll("button[data-ans]").forEach(btn => {
      btn.addEventListener("click", () => {
        if (state.blocking) return;
        const ans = btn.getAttribute("data-ans");
        const ok = q.a.includes(ans);
        answerCommon(ok, ok ? "ã›ã„ã‹ã„ï¼" : `ã–ã‚“ã­ã‚“â€¦ï¼ˆã“ãŸãˆï¼š${q.a[0]}ï¼‰`);
        state.answered.add("y:" + q.k);
      });
    });
  }

  // ---- KAKI ----
  function renderKaki() {
    const q = KAKI_QUESTIONS[Math.floor(Math.random() * KAKI_QUESTIONS.length)];
    state.current = q;
    setPills();
    const pool = KAKI_QUESTIONS.map(x => x.k).filter(k => k !== q.k);
    const opts = shuffle([q.k, ...pickN(pool, 2)]);
    el.card.innerHTML = `
      <div class="title">âœï¸ ã‹ã</div>
      <div class="prompt">ã‚ˆã¿ï¼š<span style="font-size:28px; font-weight:1100; color: var(--accent);">${q.y}</span></div>
      <div class="prompt" style="margin-top:0;">ã©ã® ã‹ã‚“ã˜ï¼Ÿ</div>
      <div class="choices">
        ${opts.map(k => `<button class="btn" data-ans="${k}">${k}</button>`).join("")}
      </div>
      <div class="tiny">â€» ã„ã¾ã¯ã€Œãˆã‚‰ã¶ã€æ–¹å¼ï¼ˆiPhoneå‘ã‘ï¼‰ã€‚</div>
    `;
    el.card.querySelectorAll("button[data-ans]").forEach(btn => {
      btn.addEventListener("click", () => {
        if (state.blocking) return;
        const ans = btn.getAttribute("data-ans");
        const ok = ans === q.k;
        answerCommon(ok, ok ? "ã›ã„ã‹ã„ï¼" : `ã–ã‚“ã­ã‚“â€¦ï¼ˆã“ãŸãˆï¼š${q.k}ï¼‰`);
        state.answered.add("k:" + q.k);
      });
    });
  }

  // ---- KAKINJUN ----
  async function renderKakinjun() {
    setPills();
    el.card.innerHTML = `
      <div class="title">ğŸ§  ã‹ãã˜ã‚…ã‚“</div>
      <div class="prompt">ãƒ‡ãƒ¼ã‚¿ã‚ˆã¿ã“ã¿ä¸­â€¦</div>
      <div class="tiny">â€» GitHub Pages ã§å‹•ãã¾ã™ï¼ˆfile:// ã ã¨å¤±æ•—ã—ã¾ã™ï¼‰</div>
    `;

    let strokes;
    try { strokes = await loadStrokes(); }
    catch (e) {
      el.card.innerHTML = `
        <div class="title">ã‚¨ãƒ©ãƒ¼</div>
        <div class="prompt">ã‹ãã˜ã‚…ã‚“ã®ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚</div>
        <div class="tiny">åŸå› ï¼š${String(e && e.message ? e.message : e)}</div>
        <div class="choices" style="margin-top:14px;">
          <button class="btn secondary" id="retry">ã‚‚ã†ã„ã¡ã©</button>
          <button class="btn" id="home">ãƒ›ãƒ¼ãƒ </button>
        </div>
      `;
      document.getElementById("retry").addEventListener("click", () => startMode("kakinjun"));
      document.getElementById("home").addEventListener("click", toHome);
      return;
    }

    const keys = Object.keys(strokes);
    const k = keys[Math.floor(Math.random() * keys.length)];
    const ds = strokes[k];
    if (!ds || ds.length < 2) return renderKakinjun();

    const hi = Math.floor(Math.random() * ds.length);
    const correct = hi + 1;

    const optSet = new Set([correct]);
    while (optSet.size < 3) optSet.add(1 + Math.floor(Math.random() * ds.length));
    const options = shuffle(Array.from(optSet));

    const view = "0 0 109 109";
    const paths = ds.map((d, idx) => {
      const cls = idx === hi ? "sHi" : "sGray";
      return `<path class="${cls}" d="${d}"></path>`;
    }).join("");

    state.current = { k, correct };

    el.card.innerHTML = `
      <div class="title">ğŸ§  ã‹ãã˜ã‚…ã‚“</div>
      <div class="strokeBox">
        <svg class="kanjiSvg" viewBox="${view}" aria-label="kanji strokes">${paths}</svg>
      </div>
      <div class="prompt">èµ¤ã„ã¨ã“ã‚ã¯ ãªã‚“ã‹ãã‚ï¼Ÿ</div>
      <div class="choices">
        ${options.map(n => `<button class="btn" data-ans="${n}">${n}ã‹ãã‚</button>`).join("")}
      </div>
      <div class="tiny">â€» èµ¤ã„ç·šãŒã€Œ${correct}ã‹ãã‚ã€ã‹ã‚’å½“ã¦ã‚‹ã‚ˆã€‚</div>
    `;

    el.card.querySelectorAll("button[data-ans]").forEach(btn => {
      btn.addEventListener("click", () => {
        if (state.blocking) return;
        const ans = Number(btn.getAttribute("data-ans"));
        const ok = ans === correct;
        answerCommon(ok, ok ? "ã›ã„ã‹ã„ï¼" : `ã–ã‚“ã­ã‚“â€¦ï¼ˆã“ãŸãˆï¼š${correct}ã‹ãã‚ï¼‰`);
        state.answered.add("s:" + k + ":" + correct);
      });
    });
  }

  // -----------------------
  // Mode start / Events
  // -----------------------
  function startMode(m) {
    state.mode = m;
    state.setIndex = 0;
    state.inSetCorrect = 0;
    state.blocking = false;
    hideOverlay();
    setPills();
    nextQuestion();
  }

  el.btnNext.addEventListener("click", () => { hideOverlay(); state.blocking = false; nextQuestion(); });
  el.btnHome.addEventListener("click", toHome);
  el.btnToHome2.addEventListener("click", toHome);
  el.btnReset.addEventListener("click", resetAll);

  loadProgress();
  setPills();

  if (initialMode === "yomi" || initialMode === "kaki" || initialMode === "kakinjun") startMode(initialMode);
  else renderHome();
})();
</script>
</body>
</html>
