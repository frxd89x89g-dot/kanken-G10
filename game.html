<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>æ¼¢æ¤œ10ç´šãƒã‚¹ã‚¿ãƒ¼ï¼ˆåˆæ ¼åŠ›Ã—20å•åŒºåˆ‡ã‚ŠÃ—æ›¸ãé †å¯¾å¿œï¼‰</title>
  <style>
    :root {
      --bg: #eef7ff;
      --card: #fff;
      --text: #0f172a;
      --muted: #64748b;
      --primary: #60a5fa;
      --accent: #fbbf24;
      --good: #22c55e;
      --bad: #ef4444;
      --shadow: 0 12px 30px rgba(0, 0, 0, .08);
      --radius: 18px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
      background:
        radial-gradient(circle at 15% 15%, rgba(251, 191, 36, .18) 0 120px, transparent 120px),
        radial-gradient(circle at 85% 25%, rgba(96, 165, 250, .18) 0 160px, transparent 160px),
        radial-gradient(circle at 35% 85%, rgba(239, 68, 68, .10) 0 140px, transparent 140px),
        var(--bg);
      color: var(--text);
      overflow: hidden;
      user-select: none;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    header {
      position: fixed;
      inset: 0 0 auto 0;
      padding: 12px 12px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255, 255, 255, .78);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(0, 0, 0, .06);
      z-index: 20;
      gap: 10px;
      flex-wrap: wrap;
    }

    .hud {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      font-weight: 1000;
    }

    .pill {
      background: #fff;
      border: 1px solid rgba(0, 0, 0, .06);
      box-shadow: var(--shadow);
      padding: 8px 10px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      white-space: nowrap;
    }

    .barWrap {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .bar {
      width: 220px;
      height: 10px;
      border-radius: 999px;
      background: #e5f0ff;
      border: 1px solid rgba(0, 0, 0, .06);
      overflow: hidden;
    }

    .gauge {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, #22c55e, #16a34a);
      transition: width .25s ease;
    }

    .btnGhost {
      background: #fff;
      border: 1px solid rgba(0, 0, 0, .08);
      color: #334155;
      box-shadow: var(--shadow);
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 1000;
      cursor: pointer;
      white-space: nowrap;
      touch-action: manipulation;
    }

    .btnGhost:active {
      transform: translateY(1px);
    }

    main {
      position: fixed;
      inset: 70px 0 0 0;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 14px;
    }

    .screen {
      width: min(580px, 94vw);
      background: var(--card);
      border: 1px solid rgba(0, 0, 0, .06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
      position: relative;
      animation: pop .22s ease;
    }

    @keyframes pop {
      from {
        transform: scale(.98);
        opacity: .5;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .tag {
      position: absolute;
      top: 14px;
      left: 14px;
      background: #e8f3ff;
      color: #1d4ed8;
      border-radius: 999px;
      padding: 6px 10px;
      font-weight: 1000;
      font-size: 13px;
    }

    .title {
      text-align: center;
      margin: 34px 0 6px;
      font-size: 38px;
      font-weight: 1100;
      color: #2563eb;
      letter-spacing: .02em;
    }

    .subtitle {
      text-align: center;
      margin: 0 0 14px;
      font-weight: 1000;
      color: #f43f5e;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 16px;
    }

    .btn {
      border: 0;
      border-radius: 14px;
      padding: 14px 12px;
      font-weight: 1100;
      cursor: pointer;
      background: #bfe0ff;
      color: #0b3b73;
      box-shadow: inset 0 -3px 0 rgba(0, 0, 0, .08);
      font-size: 16px;
      touch-action: manipulation;
      appearance: none;
      -webkit-appearance: none;
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: inset 0 -2px 0 rgba(0, 0, 0, .08);
    }

    .btnAccent {
      background: #fde68a;
      color: #5b3a00;
    }

    .btnWide {
      width: 100%;
    }

    .qBigKanji {
      font-size: 96px;
      text-align: center;
      margin: 18px 0 6px;
      line-height: 1;
      font-weight: 1100;
    }

    .qBigKana {
      font-size: 56px;
      text-align: center;
      margin: 22px 0 6px;
      line-height: 1.2;
      font-weight: 1100;
    }

    .prompt {
      text-align: center;
      font-weight: 1100;
      color: #334155;
      margin: 8px 0 10px;
    }

    .counter {
      text-align: center;
      color: var(--muted);
      font-weight: 1000;
      font-size: 13px;
      margin: 6px 0 0;
    }

    .choices {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 12px;
    }

    /* âœ… é‡è¦ï¼šiPhoneã§ç¢ºå®Ÿã«åå¿œã™ã‚‹ã‚ˆã† button ã«ã™ã‚‹ */
    .choice {
      width: 100%;
      background: #bfe0ff;
      border: 1px solid rgba(0, 0, 0, .06);
      border-radius: 14px;
      padding: 14px 12px;
      font-weight: 1100;
      font-size: 20px;
      text-align: center;
      cursor: pointer;
      box-shadow: inset 0 -3px 0 rgba(0, 0, 0, .08);
      touch-action: manipulation;
      appearance: none;
      -webkit-appearance: none;
    }

    .choice:active {
      transform: translateY(1px);
      box-shadow: inset 0 -2px 0 rgba(0, 0, 0, .08);
    }

    .explain {
      margin-top: 10px;
      font-weight: 1000;
      color: var(--muted);
      text-align: center;
      font-size: 13px;
      display: none;
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 14px;
      transform: translateX(-50%);
      background: rgba(15, 23, 42, .92);
      color: #fff;
      padding: 12px 14px;
      border-radius: 999px;
      font-weight: 1100;
      box-shadow: var(--shadow);
      display: none;
      max-width: 94vw;
      text-align: center;
      z-index: 50;
    }

    .svgBox {
      width: 240px;
      height: 240px;
      margin: 18px auto 8px;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #fff;
      border-radius: 16px;
      border: 1px solid rgba(0, 0, 0, .06);
      box-shadow: inset 0 -3px 0 rgba(0, 0, 0, .05);
    }

    svg {
      width: 220px;
      height: 220px;
    }

    .strokeBase {
      stroke: #111827;
      stroke-width: 9;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
      opacity: .22;
    }

    .strokeRed {
      stroke: #ff3b30;
      stroke-width: 10;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
      opacity: 1;
      filter: drop-shadow(0 2px 0 rgba(0, 0, 0, .06));
    }

    .loading {
      padding: 46px 0 18px;
      text-align: center;
      color: var(--muted);
      font-weight: 1100;
    }

    .spinner {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      border: 4px solid #dbeafe;
      border-top-color: #2563eb;
      margin: 0 auto 12px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .footerNote {
      margin-top: 14px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
      line-height: 1.4;
      text-align: center;
      white-space: pre-line;
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-top: 10px;
    }

    .chip {
      background: #f1f5f9;
      border: 1px solid rgba(0, 0, 0, .06);
      border-radius: 999px;
      padding: 6px 10px;
      font-weight: 1100;
      font-size: 13px;
      color: #334155;
    }

    .chipGood {
      background: #dcfce7;
      border-color: #86efac;
      color: #14532d;
    }

    .chipNew {
      background: #fff7ed;
      border-color: #fed7aa;
      color: #7c2d12;
    }

    .warn {
      background: #fff7ed;
      border: 1px solid rgba(0, 0, 0, .06);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 1000;
      color: #7c2d12;
      margin-top: 12px;
      line-height: 1.4;
      white-space: pre-line;
    }

    /* âœ… JSãŒè½ã¡ãŸæ™‚ã«ã€Œç„¡åå¿œã€ã«ãªã‚‰ãªã„ãŸã‚ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    .fatal {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, .92);
      display: none;
      z-index: 9999;
      padding: 16px;
      overflow: auto;
    }

    .fatal h2 {
      margin: 8px 0;
      color: #ef4444;
    }

    .fatal pre {
      background: #0f172a;
      color: #e2e8f0;
      padding: 12px;
      border-radius: 12px;
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 12px;
    }
  </style>
</head>

<body>
  <header>
    <div class="hud">
      <div class="pill">Lv.<span id="level">1</span></div>
      <div class="pill">å®Œæˆ(ãƒ©ãƒ³ã‚¯3) <span id="mastered">0</span>/80</div>
      <div class="pill">ã“ã®ã‚»ãƒƒãƒˆ <span id="todayDone">0</span>/<span id="limit">20</span></div>
      <div class="barWrap">
        <div style="font-weight:1100;color:#334155;">å®Œæˆãƒ¡ãƒ¼ã‚¿ãƒ¼</div>
        <div class="bar">
          <div id="gauge" class="gauge"></div>
        </div>
      </div>
    </div>
    <div style="display:flex; gap:10px; align-items:center;">
      <button class="btnGhost" id="homeBtn" type="button">ãƒ›ãƒ¼ãƒ </button>
      <button class="btnGhost" id="resetBtn" type="button" title="å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã™">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </header>

  <main id="root"></main>
  <div class="toast" id="toast"></div>

  <div class="fatal" id="fatal">
    <h2>ã‚¨ãƒ©ãƒ¼ã§åœæ­¢ã—ã¾ã—ãŸ</h2>
    <div class="warn">ã“ã®ç”»é¢ãŒå‡ºãŸã‚‰ã€JavaScriptãŒã©ã“ã‹ã§è½ã¡ã¦ã„ã¾ã™ã€‚ä¸‹ã®å†…å®¹ã‚’ãã®ã¾ã¾è²¼ã‚Œã°åŸå› ã‚’å³ç‰¹å®šã§ãã¾ã™ã€‚</div>
    <pre id="fatalText"></pre>
  </div>

  <script>
    /* =========================================================
       æ¼¢æ¤œ10ç´šãƒã‚¹ã‚¿ãƒ¼ï¼ˆåˆæ ¼åŠ›Ã—åŒºåˆ‡ã‚ŠÃ—æ›¸ãé †ï¼‰
       - 80å­—ï¼šç¿’å¾—ãƒ©ãƒ³ã‚¯ 0..3ï¼ˆ0æœª/1èª­ã¿/2é¸æŠæ›¸ã/3æ›¸ãé †ï¼‰
       - å…¨ä½“Lvï¼šãƒ©ãƒ³ã‚¯3ã®å­—æ•°ã§10å­—ã”ã¨ã«ä¸Šæ˜‡ï¼ˆçµ‚ã‚ã‚ŠãŒã‚ã‚‹ï¼‰
       - å„å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ï¼š20å•ã§å¿…ãšçµ‚äº†ï¼ˆæ¨¡è©¦ã¯10å•ï¼‰
       - æ›¸ãé †ï¼šKanjiVGã®ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯é †SVGã‹ã‚‰ã€Œèµ¤ã„ç·šã¯ä½•ç”»ç›®ï¼Ÿã€ã‚’ç”Ÿæˆ
         â€»åˆå›ã ã‘ãƒãƒƒãƒˆå¿…è¦ã€‚å¤±æ•—ã—ãŸã‚‰å¿…ãšæˆ»ã‚‹ï¼ˆå›ºã¾ã‚‰ãªã„ï¼‰
       ========================================================= */

    const root = document.getElementById("root");
    const toastEl = document.getElementById("toast");
    const levelEl = document.getElementById("level");
    const masteredEl = document.getElementById("mastered");
    const todayDoneEl = document.getElementById("todayDone");
    const limitEl = document.getElementById("limit");
    const gaugeEl = document.getElementById("gauge");

    const fatalEl = document.getElementById("fatal");
    const fatalText = document.getElementById("fatalText");
    function showFatal(message) {
      fatalText.textContent = message || "Unknown error";
      fatalEl.style.display = "block";
    }

    function toast(msg) {
      toastEl.textContent = msg;
      toastEl.style.display = "block";
      clearTimeout(toast._t);
      toast._t = setTimeout(() => toastEl.style.display = "none", 1200);
    }
    function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }
    function shuffle(arr) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    /* âœ… iOSã® :active ã‚’åŠ¹ã‹ã›ã‚‹ãŠã¾ã˜ãªã„ï¼ˆå‰¯ä½œç”¨ãªã—ï¼‰ */
    document.addEventListener("touchstart", () => { }, { passive: true });

    function el(tag, attrs = {}, children = []) {
      const n = document.createElement(tag);

      for (const [k, v] of Object.entries(attrs)) {
        if (k === "class") n.className = v;
        else if (k === "style") n.setAttribute("style", v);
        else if (k.startsWith("on") && typeof v === "function") {
          const ev = k.slice(2).toLowerCase();
          // âœ… FIX: Use ONLY ONE event type (pointerup) to prevent double-firing
          if (ev === "click") {
            n.addEventListener("pointerup", (e) => { e.preventDefault(); v(e); });
          } else {
            n.addEventListener(ev, v);
          }
        } else n.setAttribute(k, v);
      }

      (Array.isArray(children) ? children : [children]).forEach(c => {
        if (c == null) return;
        n.appendChild(typeof c === "string" ? document.createTextNode(c) : c);
      });
      return n;
    }

    // âœ… UI lock management
    let isNextRunning = false;

    function screen(node) {
      root.innerHTML = "";
      root.appendChild(node);
      state.blocking = false; // âœ… FIX: Unlock input when screen updates
    }

    /** 10ç´š 80å­—ï¼ˆå›ºå®šï¼‰ */
    const KANJI_10 = [
      "ä¸€", "å³", "é›¨", "å††", "ç‹", "éŸ³", "ä¸‹", "ç«", "èŠ±", "è²",
      "å­¦", "æ°—", "ä¹", "ä¼‘", "ç‰", "é‡‘", "ç©º", "æœˆ", "çŠ¬", "è¦‹",
      "äº”", "å£", "æ ¡", "å·¦", "ä¸‰", "å±±", "å­", "å››", "ç³¸", "å­—",
      "è€³", "ä¸ƒ", "è»Š", "æ‰‹", "å", "å‡º", "å¥³", "å°", "ä¸Š", "æ£®",
      "äºº", "æ°´", "æ­£", "ç”Ÿ", "é’", "å¤•", "çŸ³", "èµ¤", "åƒ", "å·",
      "å…ˆ", "æ—©", "è‰", "è¶³", "æ‘", "å¤§", "ç”·", "ç«¹", "ä¸­", "è™«",
      "ç”º", "å¤©", "ç”°", "åœŸ", "äºŒ", "æ—¥", "å…¥", "å¹´", "ç™½", "å…«",
      "ç™¾", "æ–‡", "æœ¨", "æœ¬", "å", "ç›®", "ç«‹", "åŠ›", "æ—", "å…­"
    ];

    /** èª­ã¿ï¼ˆä»£è¡¨ï¼‹è¨±å®¹ï¼‰ */
    const READING = {
      "ä¸€": { main: "ã„ã¡", ok: ["ã„ã¡", "ã²ã¨"] },
      "å³": { main: "ã¿ã", ok: ["ã¿ã"] },
      "é›¨": { main: "ã‚ã‚", ok: ["ã‚ã‚"] },
      "å††": { main: "ãˆã‚“", ok: ["ãˆã‚“"] },
      "ç‹": { main: "ãŠã†", ok: ["ãŠã†"] },
      "éŸ³": { main: "ãŠã¨", ok: ["ãŠã¨"] },
      "ä¸‹": { main: "ã—ãŸ", ok: ["ã—ãŸ"] },
      "ç«": { main: "ã²", ok: ["ã²"] },
      "èŠ±": { main: "ã¯ãª", ok: ["ã¯ãª"] },
      "è²": { main: "ã‹ã„", ok: ["ã‹ã„"] },

      "å­¦": { main: "ã¾ãªã¶", ok: ["ã¾ãªã¶", "ãŒã"] },
      "æ°—": { main: "ã", ok: ["ã"] },
      "ä¹": { main: "ãã‚…ã†", ok: ["ãã‚…ã†"] },
      "ä¼‘": { main: "ã‚„ã™ã‚€", ok: ["ã‚„ã™ã‚€", "ã‚„ã™"] },
      "ç‰": { main: "ãŸã¾", ok: ["ãŸã¾"] },
      "é‡‘": { main: "ãã‚“", ok: ["ãã‚“", "ã‹ã­"] },
      "ç©º": { main: "ãã‚‰", ok: ["ãã‚‰"] },
      "æœˆ": { main: "ã¤ã", ok: ["ã¤ã"] },
      "çŠ¬": { main: "ã„ã¬", ok: ["ã„ã¬"] },
      "è¦‹": { main: "ã¿ã‚‹", ok: ["ã¿ã‚‹"] },

      "äº”": { main: "ã”", ok: ["ã”"] },
      "å£": { main: "ãã¡", ok: ["ãã¡"] },
      "æ ¡": { main: "ã“ã†", ok: ["ã“ã†"] },
      "å·¦": { main: "ã²ã ã‚Š", ok: ["ã²ã ã‚Š"] },
      "ä¸‰": { main: "ã•ã‚“", ok: ["ã•ã‚“"] },
      "å±±": { main: "ã‚„ã¾", ok: ["ã‚„ã¾"] },
      "å­": { main: "ã“", ok: ["ã“"] },
      "å››": { main: "ã‚ˆã‚“", ok: ["ã‚ˆã‚“", "ã—"] },
      "ç³¸": { main: "ã„ã¨", ok: ["ã„ã¨"] },
      "å­—": { main: "ã˜", ok: ["ã˜"] },

      "è€³": { main: "ã¿ã¿", ok: ["ã¿ã¿"] },
      "ä¸ƒ": { main: "ãªãª", ok: ["ãªãª", "ã—ã¡"] },
      "è»Š": { main: "ãã‚‹ã¾", ok: ["ãã‚‹ã¾"] },
      "æ‰‹": { main: "ã¦", ok: ["ã¦"] },
      "å": { main: "ã˜ã‚…ã†", ok: ["ã˜ã‚…ã†", "ã¨ãŠ"] },
      "å‡º": { main: "ã§ã‚‹", ok: ["ã§ã‚‹", "ã ã™"] },
      "å¥³": { main: "ãŠã‚“ãª", ok: ["ãŠã‚“ãª"] },
      "å°": { main: "ã¡ã„ã•ã„", ok: ["ã¡ã„ã•ã„", "ã¡ã„"] },
      "ä¸Š": { main: "ã†ãˆ", ok: ["ã†ãˆ"] },
      "æ£®": { main: "ã‚‚ã‚Š", ok: ["ã‚‚ã‚Š"] },

      "äºº": { main: "ã²ã¨", ok: ["ã²ã¨"] },
      "æ°´": { main: "ã¿ãš", ok: ["ã¿ãš"] },
      "æ­£": { main: "ãŸã ã—ã„", ok: ["ãŸã ã—ã„"] },
      "ç”Ÿ": { main: "ã„ãã‚‹", ok: ["ã„ãã‚‹", "ãªã¾"] },
      "é’": { main: "ã‚ãŠ", ok: ["ã‚ãŠ"] },
      "å¤•": { main: "ã‚†ã†", ok: ["ã‚†ã†"] },
      "çŸ³": { main: "ã„ã—", ok: ["ã„ã—"] },
      "èµ¤": { main: "ã‚ã‹", ok: ["ã‚ã‹"] },
      "åƒ": { main: "ã›ã‚“", ok: ["ã›ã‚“"] },
      "å·": { main: "ã‹ã‚", ok: ["ã‹ã‚"] },

      "å…ˆ": { main: "ã•ã", ok: ["ã•ã"] },
      "æ—©": { main: "ã¯ã‚„ã„", ok: ["ã¯ã‚„ã„"] },
      "è‰": { main: "ãã•", ok: ["ãã•"] },
      "è¶³": { main: "ã‚ã—", ok: ["ã‚ã—"] },
      "æ‘": { main: "ã‚€ã‚‰", ok: ["ã‚€ã‚‰"] },
      "å¤§": { main: "ãŠãŠãã„", ok: ["ãŠãŠãã„", "ãŠãŠ"] },
      "ç”·": { main: "ãŠã¨ã“", ok: ["ãŠã¨ã“"] },
      "ç«¹": { main: "ãŸã‘", ok: ["ãŸã‘"] },
      "ä¸­": { main: "ãªã‹", ok: ["ãªã‹"] },
      "è™«": { main: "ã‚€ã—", ok: ["ã‚€ã—"] },

      "ç”º": { main: "ã¾ã¡", ok: ["ã¾ã¡"] },
      "å¤©": { main: "ã¦ã‚“", ok: ["ã¦ã‚“"] },
      "ç”°": { main: "ãŸ", ok: ["ãŸ"] },
      "åœŸ": { main: "ã¤ã¡", ok: ["ã¤ã¡"] },
      "äºŒ": { main: "ã«", ok: ["ã«"] },
      "æ—¥": { main: "ã²", ok: ["ã²"] },
      "å…¥": { main: "ã¯ã„ã‚‹", ok: ["ã¯ã„ã‚‹", "ã„ã‚‹"] },
      "å¹´": { main: "ã¨ã—", ok: ["ã¨ã—", "ã­ã‚“"] },
      "ç™½": { main: "ã—ã‚", ok: ["ã—ã‚"] },
      "å…«": { main: "ã¯ã¡", ok: ["ã¯ã¡"] },

      "ç™¾": { main: "ã²ã‚ƒã", ok: ["ã²ã‚ƒã"] },
      "æ–‡": { main: "ã¶ã‚“", ok: ["ã¶ã‚“"] },
      "æœ¨": { main: "ã", ok: ["ã"] },
      "æœ¬": { main: "ã»ã‚“", ok: ["ã»ã‚“"] },
      "å": { main: "ãªã¾ãˆ", ok: ["ãªã¾ãˆ"] },
      "ç›®": { main: "ã‚", ok: ["ã‚"] },
      "ç«‹": { main: "ãŸã¤", ok: ["ãŸã¤"] },
      "åŠ›": { main: "ã¡ã‹ã‚‰", ok: ["ã¡ã‹ã‚‰"] },
      "æ—": { main: "ã¯ã‚„ã—", ok: ["ã¯ã‚„ã—"] },
      "å…­": { main: "ã‚ã", ok: ["ã‚ã"] }
    };

    /* ---------- Save / State ---------- */
    const STORAGE_KEY = "kanken10_master_v2";
    const STROKE_CACHE_KEY = "kvgStrokeCache_10kyu_v2";

    const state = {
      mode: "home",
      blocking: false, // âœ… FIX: Execution guard
      progress: {},
      mistakes: {},
      session: {
        limit: 20,
        done: 0,
        correct: 0,
        total: 0,
        rankUps: {},
        newlyMastered: new Set()
      }
    };

    function initProgress() {
      for (const k of KANJI_10) {
        if (typeof state.progress[k] !== "number") state.progress[k] = 0;
      }
    }

    function load() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          const s = JSON.parse(raw);
          state.progress = s.progress || {};
          state.mistakes = s.mistakes || {};
        }
      } catch (e) { }
      initProgress();
    }
    function save() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        progress: state.progress,
        mistakes: state.mistakes
      }));
    }

    function masteredCount() {
      return Object.values(state.progress).filter(v => v === 3).length;
    }
    function calcLevel() {
      const m = masteredCount();
      return Math.floor(m / 10) + 1;
    }
    function renderHud() {
      const m = masteredCount();
      levelEl.textContent = String(calcLevel());
      masteredEl.textContent = String(m);
      todayDoneEl.textContent = String(state.session.done || 0);
      limitEl.textContent = String(state.session.limit || 20);
      const pct = (m / 80) * 100;
      gaugeEl.style.width = clamp(pct, 0, 100) + "%";
    }

    /* ---------- å‡ºé¡Œã®é‡ã¿ï¼ˆä½ãƒ©ãƒ³ã‚¯ï¼†ãƒŸã‚¹å¤šã‚ã‚’å„ªå…ˆï¼‰ ---------- */
    function weightedPickKanji() {
      const weights = KANJI_10.map(k => {
        const rank = state.progress[k] || 0;
        const base = (3 - rank) + 1;
        const miss = (state.mistakes[k] || 0) * 2;
        const damp = (rank === 3) ? 0.4 : 1;
        return (base + miss) * damp;
      });
      const sum = weights.reduce((a, b) => a + b, 0);
      let r = Math.random() * sum;
      for (let i = 0; i < KANJI_10.length; i++) {
        r -= weights[i];
        if (r <= 0) return KANJI_10[i];
      }
      return KANJI_10[KANJI_10.length - 1];
    }

    function makeReadingChoices(correct, count = 3) {
      const pool = new Set([correct]);
      while (pool.size < count) {
        const k = KANJI_10[Math.floor(Math.random() * KANJI_10.length)];
        const cand = READING[k]?.main;
        if (cand && cand !== correct) pool.add(cand);
      }
      return shuffle([...pool]);
    }
    function makeKanjiChoices(correctKanji, count = 3) {
      const pool = new Set([correctKanji]);
      while (pool.size < count) {
        const k = weightedPickKanji();
        if (k !== correctKanji) pool.add(k);
      }
      return shuffle([...pool]);
    }

    /* ---------- æ›¸ãé †ï¼šKanjiVG ---------- */
    let strokeCache = {};
    try { strokeCache = JSON.parse(localStorage.getItem(STROKE_CACHE_KEY) || "{}"); } catch (e) { strokeCache = {}; }

    function codepointHex(ch) { return ch.codePointAt(0).toString(16).padStart(5, "0"); }

    function kvgUrlFor(ch) {
      const hex = codepointHex(ch);
      return `./kanji-svg/${hex}.svg`; // âœ… FIX: Local path
    }

    function parseKanjiVG(svgText) {
      const doc = new DOMParser().parseFromString(svgText, "image/svg+xml");
      const paths = Array.from(doc.querySelectorAll("path"))
        .map(p => ({ id: p.getAttribute("id") || "", d: p.getAttribute("d") || "" }))
        .filter(x => x.d && /-s\d+/.test(x.id));

      paths.sort((a, b) => {
        const na = parseInt((a.id.match(/-s(\d+)/) || [])[1] || "9999", 10);
        const nb = parseInt((b.id.match(/-s(\d+)/) || [])[1] || "9999", 10);
        return na - nb;
      });

      const ds = paths.map(x => x.d);
      return ds.length ? ds : null;
    }

    async function getStrokes(ch) {
      if (strokeCache[ch]?.ds?.length) return strokeCache[ch].ds;

      const url = kvgUrlFor(ch);

      // âœ… FIX: Promise.race with timeout
      const res = await Promise.race([
        fetch(url, { cache: "no-store" }),
        new Promise((_, reject) =>
          setTimeout(() => reject(new Error("Timeout loading SVG: " + url)), 8000)
        )
      ]);

      if (!res.ok) {
        throw new Error("SVG fetch failed: " + res.status + " / " + url);
      }

      const txt = await res.text();
      const ds = parseKanjiVG(txt);
      if (!ds) {
        throw new Error("Stroke parse failed: " + url);
      }

      strokeCache[ch] = { ds, t: Date.now() };
      localStorage.setItem(STROKE_CACHE_KEY, JSON.stringify(strokeCache));
      return ds;
    }

    function makeStrokeSvg(ds, redIndex) {
      const svgNS = "http://www.w3.org/2000/svg";
      const svg = document.createElementNS(svgNS, "svg");
      svg.setAttribute("viewBox", "0 0 109 109");

      ds.forEach(d => {
        const p = document.createElementNS(svgNS, "path");
        p.setAttribute("d", d);
        p.setAttribute("class", "strokeBase");
        svg.appendChild(p);
      });

      const r = ds[redIndex - 1];
      if (r) {
        const p = document.createElementNS(svgNS, "path");
        p.setAttribute("d", r);
        p.setAttribute("class", "strokeRed");
        svg.appendChild(p);
      }
      return svg;
    }

    /* ---------- åˆæ ¼åŠ›ï¼ˆãƒ©ãƒ³ã‚¯ï¼‰æ›´æ–° ---------- */
    function tryRankUp(kanji, targetRank) {
      if (state.mode === "mock") return;
      const prev = state.progress[kanji] || 0;
      const next = Math.max(prev, targetRank);
      if (next > prev) {
        state.progress[kanji] = next;
        state.session.rankUps[kanji] = state.session.rankUps[kanji] || { from: prev, to: next };
        state.session.rankUps[kanji].to = next;
        if (next === 3 && prev < 3) state.session.newlyMastered.add(kanji);
        save();
        renderHud();
      }
    }

    /* ---------- ãƒŸã‚¹ç®¡ç† ---------- */
    function addMistake(kanji) {
      state.mistakes[kanji] = (state.mistakes[kanji] || 0) + 1;
      save();
    }
    function reduceMistake(kanji) {
      if (!state.mistakes[kanji]) return;
      state.mistakes[kanji] = Math.max(0, state.mistakes[kanji] - 1);
      if (state.mistakes[kanji] === 0) delete state.mistakes[kanji];
      save();
    }

    /* ---------- ç”»é¢ ---------- */
    function viewHome() {
      state.mode = "home";
      state.session = { limit: 20, done: 0, correct: 0, total: 0, rankUps: {}, newlyMastered: new Set() };
      renderHud();

      const card = el("div", { class: "screen" }, [
        el("div", { class: "tag" }, "ãƒ¡ãƒ‹ãƒ¥ãƒ¼"),
        el("div", { class: "title" }, "ã‹ã‚“ã‘ã‚“10ãã‚…ã†"),
        el("div", { class: "subtitle" }, "åˆæ ¼åŠ›ï¼ˆãƒ©ãƒ³ã‚¯ï¼‰ã§ä»•ä¸Šã’ã‚‹ï¼"),
        el("div", { class: "grid" }, [
          el("button", { class: "btn", type: "button", onClick: () => startMode("yomi") }, "ğŸ“– ã‚ˆã¿ã‹ãŸï¼ˆ0â†’1ï¼‰"),
          el("button", { class: "btn", type: "button", onClick: () => startMode("kakuSelect") }, "âœï¸ ãˆã‚‰ã‚“ã§ ã‹ãï¼ˆ1â†’2ï¼‰"),
          el("button", { class: "btn", type: "button", onClick: () => startMode("kakijun") }, "1ï¸âƒ£ ã‹ãã˜ã‚…ã‚“ï¼ˆ2â†’3ï¼‰"),
          el("button", { class: "btn btnAccent", type: "button", onClick: () => startMode("mock") }, "â±ï¸ 10ãã‚…ã†ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼ˆç¢ºèªï¼‰"),
        ]),
        el("div", { class: "footerNote" },
          "å„ãƒ¢ãƒ¼ãƒ‰ã¯ 20å•ã§ ãŠã‚ã‚‹ã‚ˆï¼ˆæ¨¡è©¦ã¯10å•ï¼‰ã€‚\n" +
          "æ›¸ãé †ã¯ KanjiVG ã®ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯é †SVGã‚’åˆ©ç”¨ï¼ˆåˆå›ãƒãƒƒãƒˆå¿…è¦ï¼‰ã€‚\n" +
          "Â© KanjiVG: CC BY-SA 3.0"
        )
      ]);
      screen(card);
    }

    function viewLoading(tagText, msg) {
      const card = el("div", { class: "screen" }, [
        el("div", { class: "tag" }, tagText),
        el("div", { class: "loading" }, [
          el("div", { class: "spinner" }),
          el("div", {}, msg || "ã‚ˆã¿ã“ã¿ã¡ã‚…ã†â€¦")
        ]),
        el("button", { class: "btn btnWide btnAccent", type: "button", onClick: viewHome }, "ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ã‚‚ã©ã‚‹")
      ]);
      screen(card);
    }

    function viewError(tagText, msg) {
      const card = el("div", { class: "screen" }, [
        el("div", { class: "tag" }, tagText),
        el("div", { class: "title", style: "margin-top:18px;font-size:30px;color:#ef4444;" }, "ã¨ã‚Œãªã‹ã£ãŸâ€¦"),
        el("div", { class: "warn" }, msg),
        el("button", { class: "btn btnWide", type: "button", onClick: () => startMode("kakijun") }, "ã‚‚ã†ã„ã¡ã©ï¼ˆã‹ãã˜ã‚…ã‚“ï¼‰"),
        el("button", { class: "btn btnWide btnAccent", type: "button", onClick: viewHome }, "ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ã‚‚ã©ã‚‹")
      ]);
      screen(card);
    }

    function viewQuestion(q) {
      const explain = el("div", { class: "explain", id: "explain" }, q.explain || "");
      const choicesWrap = el("div", { class: "choices" },
        q.choices.map(c =>
          el("button", { class: "choice", type: "button", onClick: () => judge(q, c) }, c)
        )
      );

      const parts = [];
      parts.push(el("div", { class: "tag" }, q.tag));
      if (q.type === "yomi") {
        parts.push(el("div", { class: "qBigKanji" }, q.kanji));
        parts.push(el("div", { class: "prompt" }, "ãªã‚“ã¦ ã‚ˆã‚€ã‹ãªï¼Ÿ"));
      }
      if (q.type === "kakuSelect") {
        parts.push(el("div", { class: "qBigKana" }, q.reading));
        parts.push(el("div", { class: "prompt" }, `ã€Œ${q.reading}ã€ã® ã‹ã‚“ã˜ã¯ï¼Ÿ`));
      }
      if (q.type === "kakijun") {
        parts.push(el("div", { class: "svgBox" }, q.svgNode));
        parts.push(el("div", { class: "prompt" }, "ã‚ã‹ã„ã¨ã“ã‚ã¯ ãªã‚“ã°ã‚“ã‚ï¼Ÿ"));
      }
      if (q.type === "mock") {
        parts.push(el("div", { class: "prompt" }, "10ãã‚…ã†ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼ˆãƒ©ãƒ³ã‚¯ã¯ä¸ŠãŒã‚‰ãªã„ï¼‰"));
        if (q.innerType === "yomi") parts.push(el("div", { class: "qBigKanji" }, q.kanji));
        if (q.innerType === "kakuSelect") parts.push(el("div", { class: "qBigKana" }, q.reading));
        parts.push(el("div", { class: "prompt" }, q.innerType === "yomi" ? "ãªã‚“ã¦ ã‚ˆã‚€ã‹ãªï¼Ÿ" : `ã€Œ${q.reading}ã€ã® ã‹ã‚“ã˜ã¯ï¼Ÿ`));
      }

      parts.push(el("div", { class: "counter" }, q.counterText));
      parts.push(choicesWrap);
      parts.push(explain);

      screen(el("div", { class: "screen" }, parts));
    }

    function showExplain() {
      const e = document.getElementById("explain");
      if (e) e.style.display = "block";
    }

    function viewResult() {
      const modeName = ({
        yomi: "ã‚ˆã¿ã‹ãŸ",
        kakuSelect: "ãˆã‚‰ã‚“ã§ ã‹ã",
        kakijun: "ã‹ãã˜ã‚…ã‚“",
        mock: "10ãã‚…ã†ãƒãƒ£ãƒ¬ãƒ³ã‚¸"
      })[state.mode] || "ã‘ã£ã‹";

      const rankUpList = Object.entries(state.session.rankUps)
        .map(([k, v]) => ({ k, from: v.from, to: v.to }))
        .sort((a, b) => (b.to - b.from) - (a.to - a.from));

      const newly = Array.from(state.session.newlyMastered);

      const tomorrow = KANJI_10
        .map(k => ({ k, rank: state.progress[k] || 0, miss: state.mistakes[k] || 0 }))
        .sort((a, b) => {
          if (a.rank !== b.rank) return a.rank - b.rank;
          return b.miss - a.miss;
        })
        .slice(0, 10)
        .map(x => x.k);

      const card = el("div", { class: "screen" }, [
        el("div", { class: "tag" }, "ã‘ã£ã‹"),
        el("div", { class: "title", style: "margin-top:18px;font-size:34px;" }, "ãã‚‡ã†ã® ã—ã‚ï¼"),
        el("div", { class: "subtitle" }, `${modeName}ï¼š${state.session.done}ã‚‚ã‚“ ãŠã‚ã‚Š`),
        el("div", { style: "text-align:center;font-weight:1100;font-size:18px;margin-top:8px;" },
          `ã›ã„ã‹ã„ï¼š${state.session.correct} / ${state.session.total}`
        ),

        el("div", { class: "footerNote" }, "ãƒ©ãƒ³ã‚¯UPã—ãŸ ã‹ã‚“ã˜"),
        el("div", { class: "chips" },
          rankUpList.length
            ? rankUpList.slice(0, 18).map(x => {
              const cls = (x.to === 3) ? "chip chipGood" : "chip";
              return el("div", { class: cls }, `${x.k}  ${x.from}â†’${x.to}`);
            })
            : [el("div", { class: "chip" }, "ãªã—ï¼ˆæ¬¡ã¯ä¸ŠãŒã‚‹ã‚ˆï¼ï¼‰")]
        ),

        el("div", { class: "footerNote" }, "ãã‚‡ã† å®Œæˆï¼ˆãƒ©ãƒ³ã‚¯3ï¼‰ã«ãªã£ãŸ ã‹ã‚“ã˜"),
        el("div", { class: "chips" },
          newly.length
            ? newly.map(k => el("div", { class: "chip chipGood" }, k))
            : [el("div", { class: "chip" }, "ãªã—ï¼ˆã‚ã¨å°‘ã—ï¼ï¼‰")]
        ),

        el("div", { class: "footerNote" }, "ã‚ã—ãŸã® ãŠã™ã™ã‚10å­—ï¼ˆå¼±ã„é †ï¼‰"),
        el("div", { class: "chips" }, tomorrow.map(k => el("div", { class: "chip chipNew" }, k))),

        el("div", { style: "display:flex;gap:10px;margin-top:14px;" }, [
          el("button", { class: "btn btnWide", type: "button", onClick: () => startMode(state.mode) }, "ã‚‚ã†1ã‚»ãƒƒãƒˆ"),
          el("button", { class: "btn btnWide btnAccent", type: "button", onClick: viewHome }, "ãƒ¡ãƒ‹ãƒ¥ãƒ¼")
        ])
      ]);
      screen(card);
    }

    /* ---------- ãƒ¢ãƒ¼ãƒ‰é€²è¡Œ ---------- */
    function startMode(mode) {
      state.mode = mode;
      state.session = {
        limit: (mode === "mock") ? 10 : 20,
        done: 0, correct: 0, total: 0,
        rankUps: {}, newlyMastered: new Set()
      };
      renderHud();
      next();
    }

    async function next() {
      // âœ… FIX: Concurrent execution guard
      if (isNextRunning) return;
      isNextRunning = true;

      try {
        if (state.session.done >= state.session.limit) {
          viewResult();
          return;
        }

        if (state.mode === "yomi") {
          const kanji = weightedPickKanji();
          const rd = READING[kanji];
          const q = {
            type: "yomi",
            tag: "ã‚ˆã¿ã‹ãŸï¼ˆ0â†’1ï¼‰",
            kanji,
            choices: makeReadingChoices(rd.main, 3),
            answer: rd.main,
            okReadings: rd.ok,
            explain: rd.ok,
            explain: rd.ok.length > 1 ? `ã»ã‹ã® ã‚ˆã¿ï¼š${rd.ok.join(" / ")}` : "",
            counterText: `ã‚‚ã‚“ã ã„ ${state.session.done + 1}/${state.session.limit}ï¼ˆã“ã®å­—ãƒ©ãƒ³ã‚¯ï¼š${state.progress[kanji] || 0}ï¼‰`
          };
          viewQuestion(q);
          return;
        }

        if (state.mode === "kakuSelect") {
          const kanji = weightedPickKanji();
          const rd = READING[kanji];
          const q = {
            type: "kakuSelect",
            tag: "ãˆã‚‰ã‚“ã§ ã‹ãï¼ˆ1â†’2ï¼‰",
            kanji,
            reading: rd.main,
            choices: makeKanjiChoices(kanji, 3),
            answer: kanji,
            explain: "",
            counterText: `ã‚‚ã‚“ã ã„ ${state.session.done + 1}/${state.session.limit}ï¼ˆã“ã®å­—ãƒ©ãƒ³ã‚¯ï¼š${state.progress[kanji] || 0}ï¼‰`
          };
          viewQuestion(q);
          return;
        }

        if (state.mode === "kakijun") {
          const kanji = weightedPickKanji();
          viewLoading("ã‹ãã˜ã‚…ã‚“ï¼ˆ2â†’3ï¼‰", `ã€Œ${kanji}ã€ã® ãƒ‡ãƒ¼ã‚¿ã‚’ ã‚ˆã¿ã“ã¿ã¡ã‚…ã†â€¦`);

          const ds = await getStrokes(kanji);
          const total = ds.length;

          const redIndex = 1 + Math.floor(Math.random() * total);
          const choiceNums = new Set([redIndex]);
          while (choiceNums.size < 3) {
            const delta = [-2, -1, 1, 2][Math.floor(Math.random() * 4)];
            choiceNums.add(clamp(redIndex + delta, 1, total));
          }
          const choices = shuffle([...choiceNums].map(n => `${n}ã‹ãã‚`));

          const q = {
            type: "kakijun",
            tag: "ã‹ãã˜ã‚…ã‚“ï¼ˆ2â†’3ï¼‰",
            kanji,
            svgNode: makeStrokeSvg(ds, redIndex),
            choices,
            answer: `${redIndex}ã‹ãã‚`,
            explain: `ã€Œ${kanji}ã€ã¯ ãœã‚“ã¶ã§ ${total}ã‹ãã€‚`,
            counterText: `ã‚‚ã‚“ã ã„ ${state.session.done + 1}/${state.session.limit}ï¼ˆã“ã®å­—ãƒ©ãƒ³ã‚¯ï¼š${state.progress[kanji] || 0}ï¼‰`
          };
          viewQuestion(q);
          return;
        }

        if (state.mode === "mock") {
          const kanji = weightedPickKanji();
          const inner = (Math.random() < 0.7) ? "yomi" : "kakuSelect";

          if (inner === "yomi") {
            const rd = READING[kanji];
            const q = {
              type: "mock",
              innerType: "yomi",
              kanji,
              choices: makeReadingChoices(rd.main, 3),
              answer: rd.main,
              okReadings: rd.ok,
              explain: rd.ok.length > 1 ? `ã»ã‹ã® ã‚ˆã¿ï¼š${rd.ok.join(" / ")}` : "",
              counterText: `ã‚‚ã‚“ã ã„ ${state.session.done + 1}/${state.session.limit}`
            };
            viewQuestion(q);
            return;
          } else {
            const rd = READING[kanji];
            const q = {
              type: "mock",
              innerType: "kakuSelect",
              kanji,
              reading: rd.main,
              choices: makeKanjiChoices(kanji, 3),
              answer: kanji,
              explain: "",
              counterText: `ã‚‚ã‚“ã ã„ ${state.session.done + 1}/${state.session.limit}`
            };
            viewQuestion(q);
            return;
          }
        }
      } catch (err) {
        console.error(err);
        viewError(
          "ã‹ãã˜ã‚…ã‚“ï¼ˆã‚¨ãƒ©ãƒ¼ï¼‰",
          "æ›¸ãé †ãƒ‡ãƒ¼ã‚¿ãŒå–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚\n\n" +
          "ãƒ»ãƒãƒƒãƒˆæ¥ç¶šãŒå¼±ã„\n" +
          "ãƒ»å­¦æ ¡/ä¼šç¤¾Wi-Fiã§CDNãŒãƒ–ãƒ­ãƒƒã‚¯\n" +
          "ãƒ»ä¸€æ™‚çš„ãªé€šä¿¡ä¸å®‰å®š\n\n" +
          "å¯¾ç­–ï¼šãƒ¢ãƒã‚¤ãƒ«å›ç·šã§è©¦ã™ / å…±æœ‰â†’Safariã§é–‹ã / ã‚‚ã†ä¸€åº¦\n\n" +
          "ã‚¨ãƒ©ãƒ¼ï¼š" + (err?.message || String(err))
        );
      } finally {
        isNextRunning = false;
      }
    }

    /* ---------- åˆ¤å®š ---------- */
    function judge(q, picked) {
      if (state.blocking) return; // âœ… FIX: Prevent re-entry
      state.blocking = true;

      showExplain();

      state.session.total += 1;
      state.session.done += 1;
      renderHud();

      let ok = false;

      if (q.type === "yomi" || (q.type === "mock" && q.innerType === "yomi")) {
        ok = (q.okReadings || []).includes(picked);
      } else {
        ok = (picked === q.answer);
      }

      if (ok) {
        state.session.correct += 1;
        reduceMistake(q.kanji);

        if (state.mode === "yomi") tryRankUp(q.kanji, 1);
        if (state.mode === "kakuSelect") tryRankUp(q.kanji, 2);
        if (state.mode === "kakijun") tryRankUp(q.kanji, 3);

        toast("ã›ã„ã‹ã„ï¼");
        setTimeout(next, 260);
      } else {
        addMistake(q.kanji);
        toast(`ã–ã‚“ã­ã‚“â€¦ ã“ãŸãˆï¼š${q.answer}`);
        setTimeout(next, 520);
      }
    }

    /* ---------- ãƒœã‚¿ãƒ³ ---------- */
    document.getElementById("homeBtn").addEventListener("click", viewHome);
    document.getElementById("resetBtn").addEventListener("click", () => {
      if (confirm("å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿï¼ˆãƒ©ãƒ³ã‚¯ãƒ»è‹¦æ‰‹è¨˜éŒ²ãŒæ¶ˆãˆã¾ã™ï¼‰")) {
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem(STROKE_CACHE_KEY);
        strokeCache = {};
        state.progress = {};
        state.mistakes = {};
        initProgress();
        save();
        toast("ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ");
        viewHome();
      }
    });

    /* âœ… ã€Œç„¡åå¿œã€ã‚’æ ¹çµ¶ï¼šã‚¨ãƒ©ãƒ¼ã‚’å¿…ãšç”»é¢ã«å‡ºã™ */
    window.addEventListener("error", (e) => {
      const msg = (e && e.message) ? e.message : "Unknown error";
      showFatal("window.error:\n" + msg + "\n\n" + (e?.filename ? (e.filename + ":" + e.lineno + ":" + e.colno) : ""));
    });
    window.addEventListener("unhandledrejection", (e) => {
      showFatal("unhandledrejection:\n" + (e?.reason?.message || String(e?.reason || e)));
    });

    /* ---------- èµ·å‹• ---------- */
    load();
    renderHud();
    viewHome();
  </script>
</body>

</html>